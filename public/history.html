<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ­·å²å ±åƒ¹æŸ¥è©¢</title>
  <meta name="robots" content="noindex,nofollow"/>

  <!-- æ ·å¼ / Icon -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/darkly/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <!-- åŒ¯å‡º Excel ç”¨ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0"><i class="fa-solid fa-magnifying-glass me-2"></i>æ­·å²å ±åƒ¹æŸ¥è©¢</h2>
    <div>
      <a href="./index.html" class="btn btn-outline-light btn-sm"><i class="fa-solid fa-arrow-left me-1"></i>è¿”å›å ±åƒ¹</a>
    </div>
  </div>

  <!-- ç¯©é¸æ¢ä»¶ -->
  <div class="card mb-4">
    <div class="card-body">
      <form id="filterForm" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">é¢¨æ ¼</label>
          <select id="style" class="form-select">
            <option value="">å…¨éƒ¨</option>
            <option>ç°¡ç´„</option><option>åŒ—æ­</option><option>æ¸…å¥¢</option>
            <option>å¤å…¸</option><option>ç¾å¼</option><option>ç¾ä»£</option>
            <option>æ—¥å¼</option><option>ç„¡å°</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">æˆ¿å‹</label>
          <select id="room_type" class="form-select">
            <option value="">å…¨éƒ¨</option>
            <option>ä¸€æˆ¿ä¸€å»³ä¸€è¡›</option>
            <option>å…©æˆ¿ä¸€å»³ä¸€è¡›</option>
            <option>å…©æˆ¿å…©å»³å…©è¡›</option>
            <option>ä¸‰æˆ¿ä¸€å»³ä¸€è¡›</option>
            <option>ä¸‰æˆ¿å…©å»³å…©è¡›</option>
            <option>ä¸‰æˆ¿å…©å»³ä¸‰è¡›</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">åªæ•¸ï¼ˆæœ€å°ï¼‰</label>
          <input id="ping_min" type="number" class="form-control" min="0" step="0.1" placeholder="ä¾‹å¦‚ 18"/>
        </div>
        <div class="col-md-3">
          <label class="form-label">åªæ•¸ï¼ˆæœ€å¤§ï¼‰</label>
          <input id="ping_max" type="number" class="form-control" min="0" step="0.1" placeholder="ä¾‹å¦‚ 28"/>
        </div>
        <div class="col-md-3">
          <label class="form-label">æ—¥æœŸï¼ˆèµ·ï¼‰</label>
          <input id="from" type="date" class="form-control"/>
        </div>
        <div class="col-md-3">
          <label class="form-label">æ—¥æœŸï¼ˆè¿„ï¼‰</label>
          <input id="to" type="date" class="form-control"/>
        </div>
        <div class="col-md-6 d-flex align-items-end justify-content-end">
          <div class="btn-group">
            <button type="button" class="btn btn-primary" id="btnSearch"><i class="fa-solid fa-search me-1"></i>æŸ¥è©¢</button>
            <button type="button" class="btn btn-secondary" id="btnReset"><i class="fa-solid fa-rotate-left me-1"></i>é‡è¨­</button>
            <button type="button" class="btn btn-success" id="btnExport"><i class="fa-solid fa-file-excel me-1"></i>åŒ¯å‡º Excel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- çµ±è¨ˆ / åˆ†é  -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div id="summary" class="text-muted">å…± 0 ç­†</div>
    <div class="btn-group">
      <button id="prev" class="btn btn-outline-light btn-sm"><i class="fa-solid fa-angle-left"></i></button>
      <button id="next" class="btn btn-outline-light btn-sm"><i class="fa-solid fa-angle-right"></i></button>
    </div>
  </div>

  <!-- çµæœè¡¨ -->
  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th>æ—¥æœŸ</th>
            <th>å®¢æˆ¶</th>
            <th>é¢¨æ ¼</th>
            <th>æˆ¿å‹</th>
            <th class="text-end">åªæ•¸</th>
            <th class="text-end">ç¸½åƒ¹</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="text-center text-muted py-4">å°šç„¡è³‡æ–™</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- è©³æƒ… Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">å ±åƒ¹è©³æƒ…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs mb-3" role="tablist">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-base" type="button" role="tab">åŸºæœ¬è³‡æ–™</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-items" type="button" role="tab">æ˜ç´°</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-form" type="button" role="tab">åŸå§‹è¡¨å–® JSON</button>
          </li>
        </ul>

        <div class="tab-content">
          <div class="tab-pane fade show active" id="tab-base" role="tabpanel">
            <div id="detailBase" class="row g-3"></div>
          </div>

          <div class="tab-pane fade" id="tab-items" role="tabpanel">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>åˆ†é¡</th>
                    <th>é …ç›®</th>
                    <th class="text-end">æ•¸é‡</th>
                    <th>å–®ä½</th>
                    <th class="text-end">å–®åƒ¹</th>
                    <th class="text-end">é‡‘é¡</th>
                  </tr>
                </thead>
                <tbody id="detailItemsBody">
                  <tr><td colspan="6" class="text-muted text-center">ç„¡æ˜ç´°</td></tr>
                </tbody>
                <tfoot>
                  <tr>
                    <th colspan="5" class="text-end">å°è¨ˆ</th>
                    <th class="text-end" id="itemsSubtotal">NT$ 0</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="tab-pane fade" id="tab-form" role="tabpanel">
            <pre id="detailForm" class="mb-0" style="white-space:pre-wrap;"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- ç‹€æ…‹èˆ‡å°å·¥å…· ---
  const state = { page: 1, limit: 20, lastResp: null, lastQuery: {} };
  const $ = (s) => document.querySelector(s);

  function nt(n){ return (n ?? 0).toLocaleString('zh-TW', { maximumFractionDigits: 0 }); }
  function fmtMoney(n){ return 'NT$ ' + nt(Math.round(Number(n)||0)); }
  function fmtDate(s){ return s ? String(s).slice(0,10) : ''; }

  // ğŸ‘‰ çµ±ä¸€æ‰“ APIï¼ˆæ”¯æ´ Basic Auth ç¬¬äºŒæ¬¡é‡è©¦ï¼‰
  async function apiGetJson(url, init = {}) {
    let resp = await fetch(url, { cache: 'no-store', ...init });
    if (resp.status === 401) resp = await fetch(url, { cache: 'no-store', ...init });
    const text = await resp.text();
    if (!resp.ok) throw new Error(\`HTTP \${resp.status} \${text || ''}\`);
    try { return JSON.parse(text); } catch { return text; }
  }

  function setLoading(msg = 'è®€å–ä¸­â€¦') {
    $('#tbody').innerHTML = \`<tr><td colspan="7" class="text-center text-muted py-4">\${msg}</td></tr>\`;
    $('#summary').textContent = '';
    $('#prev').disabled = true;
    $('#next').disabled = true;
  }

  function collectQuery(){
    const q = {
      style: $('#style').value.trim(),
      room_type: $('#room_type').value.trim(),
      ping_min: $('#ping_min').value.trim(),
      ping_max: $('#ping_max').value.trim(),
      from: $('#from').value.trim(),
      to: $('#to').value.trim(),
      page: state.page,
      limit: state.limit
    };
    Object.keys(q).forEach(k => { if(q[k] === '') delete q[k]; });
    return q;
  }

  async function search(page = 1){
    state.page = page;
    setLoading();
    try{
      const q = state.lastQuery = collectQuery();
      const sp = new URLSearchParams(q);
      const data = await apiGetJson('/api/search-quotes?' + sp.toString());
      state.lastResp = data;
      render(data);
    }catch(err){
      console.error(err);
      $('#tbody').innerHTML =
        \`<tr><td colspan="7" class="text-center text-danger py-4">æŸ¥è©¢å¤±æ•—ï¼š\${err.message || err}</td></tr>\`;
      $('#summary').textContent = 'å…± 0 ç­†';
    }
  }

  function render(resp){
    const tbody = $('#tbody');
    if(!resp || !Array.isArray(resp.items) || resp.items.length === 0){
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
      $('#summary').textContent = 'å…± 0 ç­†';
      $('#prev').disabled = true;
      $('#next').disabled = true;
      return;
    }

    tbody.innerHTML = resp.items.map(r => \`
      <tr>
        <td>\${fmtDate(r.quote_date || r.created_at)}</td>
        <td>\${r.client_name ?? ''}</td>
        <td>\${r.style ?? ''}</td>
        <td>\${r.room_type ?? ''}</td>
        <td class="text-end">\${r.base_ping ?? ''}</td>
        <td class="text-end">\${fmtMoney(r.grand_total)}</td>
        <td>
          <button class="btn btn-sm btn-outline-info" onclick="showDetail('\${r.id}')">
            <i class="fa-solid fa-eye me-1"></i>æŸ¥çœ‹
          </button>
        </td>
      </tr>\`
    ).join('');

    const totalTxt = (resp.total != null)
      ? \`å…± \${resp.total.toLocaleString()} ç­†ï¼Œé  \${resp.page}\`
      : \`é  \${resp.page}\`;
    $('#summary').textContent = totalTxt;

    $('#prev').disabled = (resp.page <= 1);
    $('#next').disabled = (resp.hasNext === false);
  }

  function exportExcel(){
    const items = state?.lastResp?.items || [];
    if(items.length === 0){ alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™'); return; }
    const rows = [['æ—¥æœŸ','å®¢æˆ¶','é¢¨æ ¼','æˆ¿å‹','åªæ•¸','ç¸½åƒ¹','ID']];
    items.forEach(r=>{
      rows.push([
        fmtDate(r.quote_date || r.created_at),
        r.client_name || '',
        r.style || '',
        r.room_type || '',
        r.base_ping ?? '',
        Math.round(Number(r.grand_total)||0),
        r.id
      ]);
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'æ­·å²å ±åƒ¹');
    const ts = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
    XLSX.writeFile(wb, \`æ­·å²å ±åƒ¹_\${ts}.xlsx\`);
  }

  async function showDetail(id){
    try{
      const row = await apiGetJson('/api/quote-detail?id=' + encodeURIComponent(id));

      const base = [
        { label:'æ—¥æœŸ', value: fmtDate(row.quote_date || row.created_at) },
        { label:'å®¢æˆ¶', value: row.client_name || '' },
        { label:'åœ°å€', value: row.address || '' },
        { label:'é¢¨æ ¼', value: row.style || '' },
        { label:'æˆ¿å‹', value: row.room_type || '' },
        { label:'åªæ•¸', value: row.base_ping ?? '' },
        { label:'å°è¨ˆ', value: fmtMoney(row.subtotal) },
        { label:'å…¶ä»–é …ç›®(10%)', value: fmtMoney(row.other_items) },
        { label:'ç›£å·¥è²»(8%)', value: fmtMoney(row.supervision_fee) },
        { label:'ç¨…é¡(5%)', value: fmtMoney(row.tax) },
        { label:'ç¸½åƒ¹', value: fmtMoney(row.grand_total) },
        { label:'ç·¨è™Ÿ', value: row.id }
      ];
      $('#detailBase').innerHTML = base.map(b => \`
        <div class="col-md-4">
          <div class="p-2 border rounded">
            <div class="text-muted small">\${b.label}</div>
            <div class="fw-semibold">\${b.value ?? ''}</div>
          </div>
        </div>\`).join('');

      const items = Array.isArray(row.quote_items) ? row.quote_items : [];
      if(items.length === 0){
        $('#detailItemsBody').innerHTML =
          '<tr><td colspan="6" class="text-muted text-center">ç„¡æ˜ç´°</td></tr>';
        $('#itemsSubtotal').textContent = 'NT$ 0';
      }else{
        let sub = 0;
        $('#detailItemsBody').innerHTML = items.map(it=>{
          sub += Number(it.amount)||0;
          return \`
            <tr>
              <td>\${it.category ?? ''}</td>
              <td>\${it.name ?? ''}</td>
              <td class="text-end">\${it.qty ?? ''}</td>
              <td>\${it.unit ?? ''}</td>
              <td class="text-end">\${fmtMoney(it.unit_price)}</td>
              <td class="text-end">\${fmtMoney(it.amount)}</td>
            </tr>\`;
        }).join('');
        $('#itemsSubtotal').textContent = fmtMoney(sub);
      }

      $('#detailForm').textContent = JSON.stringify(row.form || {}, null, 2);

      new bootstrap.Modal($('#detailModal')).show();
    }catch(err){
      console.error(err);
      alert(err.message || err);
    }
  }

  // ç¶äº‹ä»¶ï¼ˆç­‰ DOM æ¸²æŸ“å®Œæˆï¼‰
  document.addEventListener('DOMContentLoaded', () => {
    $('#btnSearch').addEventListener('click', ()=>search(1));
    $('#btnReset').addEventListener('click', ()=>{
      $('#filterForm').reset();
      state.page = 1;
      search(1);
    });
    $('#btnExport').addEventListener('click', exportExcel);
    $('#prev').addEventListener('click', ()=> search(Math.max(1, state.page-1)));
    $('#next').addEventListener('click', ()=> search(state.page+1));

    // é¦–æ¬¡è¼‰å…¥å°±æŸ¥ä¸€æ¬¡
    search(1);
  });
</script>
</body>
</html>
