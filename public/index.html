<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>室內裝修報價系統 - 完整版（動態＋美化匯出）</title>
  <meta name="robots" content="noindex, nofollow"/>

  <!-- UI 套件 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/darkly/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- 匯出 Excel：改用 ExcelJS + FileSaver（可做樣式） -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Microsoft JhengHei", sans-serif; line-height: 1.6; }
    .display-4 { font-weight: 600; color: var(--bs-primary); }
    .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); margin-bottom: 1.25rem; }
    .card-header { background-color: var(--bs-dark); border-bottom: 2px solid var(--bs-primary); font-weight: 600; }
    .form-control:focus, .form-select:focus { border-color: var(--bs-primary); box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25); }
    .pricing-breakdown { animation: fadeIn .2s ease-in; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(6px);} to {opacity:1; transform: translateY(0);} }
    .auto-calc { background-color: rgba(13,110,253,.08); border-color: var(--bs-primary); }
    .input-group-text { background-color: var(--bs-secondary); border-color: var(--bs-border-color); }
    .custom-input { display:none; } .custom-input.show{ display:block; }
  </style>

  <!-- 簡易密碼門禁 -->
  <script>
    (function () {
      var pass = prompt("請輸入密碼以訪問報價系統");
      if (pass !== "93784793") {
        document.documentElement.innerHTML =
          "<!DOCTYPE html><html><head><title>拒絕訪問</title><style>body{font-family:Arial,sans-serif;text-align:center;margin-top:100px;font-size:24px;color:#ff0000;background:#000;}</style></head><body><h1>無權訪問</h1><p>密碼錯誤，拒絕訪問此系統</p></body></html>";
        if (window.stop) window.stop();
        if (document.execCommand) document.execCommand("Stop");
        throw new Error("Access denied");
      }
    })();
  </script>
  <style id="hideContent"> body { display: none !important; } </style>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var hideStyle = document.getElementById('hideContent');
      if (hideStyle) hideStyle.remove();
      document.body.style.display = 'block';
    });
  </script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="text-center py-4 mb-4 border-bottom">
      <h1 class="display-4"><i class="fas fa-hammer me-3"></i>室內裝修報價系統</h1>
      <p class="lead text-muted">動態輸入、即時試算、Excel 美化匯出與資料庫儲存</p>
    </div>

    <div class="row">
      <!-- Left: Form -->
      <div class="col-lg-8">
        <form id="quotationForm">
          <!-- 客戶資訊 -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-user me-2"></i>客戶資訊</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">客戶名稱</label>
                  <input id="client_name" class="form-control" placeholder="可空白">
                </div>
                <div class="col-md-6">
                  <label class="form-label">報價日期</label>
                  <input id="date" type="date" class="form-control">
                </div>
                <div class="col-12">
                  <label class="form-label">地址</label>
                  <input id="address" class="form-control" placeholder="可空白">
                </div>
                <div class="col-md-6">
                  <label class="form-label">風格</label>
                  <select id="style" class="form-select" onchange="toggleCustomInput('style')">
                    <option value="">請選擇風格</option>
                    <option value="簡約">簡約</option><option value="北歐">北歐</option><option value="清奢">清奢</option>
                    <option value="古典">古典</option><option value="美式">美式</option><option value="現代">現代</option>
                    <option value="日式">日式</option><option value="無印">無印</option><option value="其他">其他：自行輸入</option>
                  </select>
                  <input id="style_custom" class="form-control mt-2 custom-input" placeholder="請輸入自訂風格">
                </div>
                <div class="col-md-6">
                  <label class="form-label">房型</label>
                  <select id="room_type" class="form-select" onchange="toggleCustomInput('room_type')">
                    <option value="">請選擇房型</option>
                    <option value="一房一廳一衛">一房一廳一衛</option>
                    <option value="兩房一廳一衛">兩房一廳一衛</option>
                    <option value="兩房兩廳兩衛">兩房兩廳兩衛</option>
                    <option value="三房一廳一衛">三房一廳一衛</option>
                    <option value="三房兩廳兩衛">三房兩廳兩衛</option>
                    <option value="三房兩廳三衛">三房兩廳三衛</option>
                    <option value="其他">其他：自行輸入</option>
                  </select>
                  <input id="room_type_custom" class="form-control mt-2 custom-input" placeholder="請輸入自訂房型">
                </div>
              </div>
            </div>
          </div>

          <!-- 基準坪數 -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-ruler me-2"></i>基準坪數</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">基準坪數 (12-40坪) *</label>
                  <input id="base_ping" type="number" min="12" max="40" value="20" class="form-control" onchange="calculatePricing()">
                  <div class="form-text">影響所有基礎工程與區間價格計算</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 基礎工程 -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-tools me-2"></i>基礎工程項目</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-check">
                    <input id="paint" class="form-check-input" type="checkbox" onchange="calculatePricing()" checked>
                    <label class="form-check-label fw-bold" for="paint">油漆</label>
                    <div><small class="text-muted">基數90,000（12坪），每坪 + <b>7,500</b></small></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check">
                    <input id="electrical" class="form-check-input" type="checkbox" onchange="calculatePricing()" checked>
                    <label class="form-check-label fw-bold" for="electrical">水電</label>
                    <div><small class="text-muted">基數60,000（12坪），每坪 + 5,000</small></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check">
                    <input id="lighting" class="form-check-input" type="checkbox" onchange="calculatePricing()" checked>
                    <label class="form-check-label fw-bold" for="lighting">燈具</label>
                    <div><small class="text-muted">基數45,000（12坪），每坪 + 3,000</small></div>
                  </div>
                </div>
                <!-- 玻璃：固定額度 -->
                <div class="col-md-6">
                  <label class="form-label">玻璃（固定額度）</label>
                  <select id="glass_select" class="form-select" onchange="toggleCustomInput('glass_select'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="15000">15,000</option>
                    <option value="20000">20,000</option>
                    <option value="25000">25,000</option>
                    <option value="30000">30,000</option>
                    <option value="35000">35,000</option>
                    <option value="40000">40,000</option>
                    <option value="45000">45,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input id="glass_select_custom" type="number" class="form-control mt-2 custom-input" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
              </div>
            </div>
          </div>

          <!-- 木作工程（動態） -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-tree me-2"></i>木作工程（可新增多列）</h5></div>
            <div class="card-body">
              <div id="woodwork-list"></div>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addWoodworkItem()">
                <i class="fas fa-plus me-1"></i>新增木作項目
              </button>
              <hr/>
              <label class="form-label">木作五金（自動：木作小計 × 5%）</label>
              <input id="woodwork_hardware" class="form-control auto-calc" readonly>
            </div>
          </div>

          <!-- 系統櫃＋床架（動態） -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-cube me-2"></i>系統櫃配置（可新增多列）</h5></div>
            <div class="card-body">
              <div class="alert alert-warning mb-3">
                <i class="fas fa-circle-info me-1"></i> 系統櫃以「尺」計價；<b>床架以公分計價（長cm × 寬cm）</b>
              </div>

              <label class="form-label fw-bold">床架（長cm × 寬cm = 金額）</label>
              <div class="card bg-secondary mb-3">
                <div class="card-body">
                  <div id="bed-frames-container"></div>
                  <button type="button" class="btn btn-outline-primary btn-sm" onclick="addBedFrame()">
                    <i class="fas fa-plus me-1"></i>新增床架
                  </button>
                </div>
              </div>

              <div id="system-list"></div>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addSystemItem()">
                <i class="fas fa-plus me-1"></i>新增系統櫃項目
              </button>

              <hr/>
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">系統五金（系統小計 × 5%）</label>
                  <input id="system_hardware" class="form-control auto-calc" readonly>
                </div>
                <div class="col-md-4">
                  <label class="form-label">運費（系統小計 × 5%）</label>
                  <input id="system_shipping" class="form-control auto-calc" readonly>
                </div>
                <div class="col-md-4">
                  <label class="form-label">組裝費（系統小計 × 20%）</label>
                  <input id="system_assembly" class="form-control auto-calc" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- 鐵件拉門 -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-door-open me-2"></i>鐵件拉門</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">鐵件拉門（含五金）</label>
                  <div class="input-group">
                    <input id="iron_sliding_door" type="number" min="0" value="0" class="form-control" onchange="calculatePricing()">
                    <span class="input-group-text">樘 × 28,000</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 開關面板 -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-toggle-on me-2"></i>開關面板</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">選擇開關面板</label>
                  <select id="switch_panel" class="form-select" onchange="calculatePricing()">
                    <option value="starlight" selected>星光 - 基數7000 每坪+600</option>
                    <option value="risna">Risna - 基數9000 每坪+700</option>
                  </select>
                  <small class="text-muted">基數為12坪，每多1坪按對應金額計算</small>
                </div>
                <div class="col-md-6">
                  <label class="form-label">開關面板金額（自動）</label>
                  <input id="switch_panel_calc" class="form-control auto-calc" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- 石作 / 特殊漆 / 鐵件 / 金屬 -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-square me-2"></i>石作工程</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">大板</label>
                  <select id="large_board" class="form-select" onchange="toggleCustomInput('large_board'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="60000">一般 - 60,000</option>
                    <option value="120000">貴一點 - 120,000</option>
                    <option value="200000">最貴 - 200,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input id="large_board_custom" type="number" class="form-control mt-2 custom-input" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-paint-roller me-2"></i>特殊漆工程</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">特殊漆</label>
                  <select id="special_paint" class="form-select" onchange="toggleCustomInput('special_paint'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="50000">一般 - 50,000</option>
                    <option value="100000">貴一點 - 100,000</option>
                    <option value="150000">最貴 - 150,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input id="special_paint_custom" type="number" class="form-control mt-2 custom-input" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-tools me-2"></i>鐵件工程</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">鐵件</label>
                  <select id="ironwork" class="form-select" onchange="toggleCustomInput('ironwork'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="40000">一般 - 40,000</option>
                    <option value="80000">貴一點 - 80,000</option>
                    <option value="120000">最貴 - 120,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input id="ironwork_custom" type="number" class="form-control mt-2 custom-input" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-cogs me-2"></i>金屬工程</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">鈦金條</label>
                  <select id="titanium_strips" class="form-select" onchange="toggleCustomInput('titanium_strips'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="10000">少-4條 - 10,000</option>
                    <option value="15000">中-6條 - 15,000</option>
                    <option value="20000">多-8條 - 20,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input id="titanium_strips_custom" type="number" class="form-control mt-2 custom-input" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
              </div>
            </div>
          </div>

          <!-- 鋁框吊框 / 高門框（動態） -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-window-maximize me-2"></i>鋁框吊框（可新增多列）</h5></div>
            <div class="card-body">
              <div id="alum-list"></div>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAlumItem()">
                <i class="fas fa-plus me-1"></i>新增鋁框項目
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-door-closed me-2"></i>高門框（可新增多列）</h5></div>
            <div class="card-body">
              <div id="tallframe-list"></div>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addTallFrameItem()">
                <i class="fas fa-plus me-1"></i>新增高門框項目
              </button>
            </div>
          </div>

          <!-- 其他單價項目 -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-list me-2"></i>其他單價項目</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">清潔 (全室含衛浴/陽台/廚房)</label>
                  <div class="input-group">
                    <input id="cleaning" type="number" min="0" step="0.1" value="0" class="form-control" onchange="calculatePricing()">
                    <span class="input-group-text">坪 × 1,200</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">木地板 (不含衛浴/陽台/廚房)</label>
                  <div class="input-group">
                    <input id="wood_flooring" type="number" min="0" step="0.1" value="0" class="form-control" onchange="calculatePricing()">
                    <span class="input-group-text">坪 × 6,500</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">室內保護</label>
                  <div class="input-group">
                    <input id="protection" type="number" min="0" step="0.1" value="0" class="form-control" onchange="calculatePricing()">
                    <span class="input-group-text">坪 × 1,000</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">清運</label>
                  <select id="waste_removal" class="form-select" onchange="toggleCustomInput('waste_removal'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="10000">10,000</option>
                    <option value="12000">12,000</option>
                    <option value="15000">15,000</option>
                    <option value="18000">18,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input id="waste_removal_custom" type="number" class="form-control mt-2 custom-input" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
                <div class="col-md-6">
                  <label class="form-label">拆除</label>
                  <select id="demolition" class="form-select" onchange="toggleCustomInput('demolition'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="6000">6,000</option>
                    <option value="8000">8,000</option>
                    <option value="10000">10,000</option>
                    <option value="12000">12,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input id="demolition_custom" type="number" class="form-control mt-2 custom-input" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
              </div>
            </div>
          </div>

          <!-- 其他自行輸入項目 -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-pen me-2"></i>其他自行輸入項目</h5></div>
            <div class="card-body">
              <div id="custom-items-container"></div>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCustomItem()">
                <i class="fas fa-plus me-1"></i>新增自訂項目
              </button>
            </div>
          </div>

          <!-- 自動項目 / 稅 -->
          <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-plus me-2"></i>其他比例項目 / 稅</h5></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">其他項目（自動：小計 × 3%）</label>
                  <input id="other_items" class="form-control auto-calc" readonly>
                </div>
                <div class="col-md-4">
                  <label class="form-label">監工費（自動：小計 × 8%）</label>
                  <input id="supervision_fee" class="form-control auto-calc" readonly>
                </div>
                <div class="col-md-4">
                  <label class="form-label">稅額（自動：小計 × 5%）</label>
                  <input id="tax" class="form-control auto-calc" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- Buttons -->
          <div class="d-grid gap-2 mb-4">
            <button type="button" class="btn btn-primary btn-lg" onclick="calculatePricing()">
              <i class="fas fa-calculator me-2"></i>重新計算報價
            </button>
            <button type="button" class="btn btn-success btn-lg" onclick="exportToExcel()">
              <i class="fas fa-file-excel me-2"></i>匯出 Excel（美化）
            </button>
            <button type="button" class="btn btn-outline-primary btn-lg" onclick="saveQuote()">
              <i class="fas fa-cloud-upload-alt me-2"></i>儲存到資料庫
            </button>
          </div>
        </form>
      </div>

      <!-- Right: Total & Breakdown -->
      <div class="col-lg-4">
        <div class="sticky-top" style="top: 2rem;">
          <div class="card mb-3">
            <div class="card-header text-center"><h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>總報價</h5></div>
            <div class="card-body text-center">
              <h2 id="total-price" class="display-5 text-primary fw-bold">NT$ 0</h2>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h6 class="mb-0"><i class="fas fa-list-ul me-2"></i>價格明細</h6></div>
            <div class="card-body">
              <div id="pricing-breakdown" class="pricing-breakdown">
                <p class="text-muted text-center">請選擇項目來查看明細</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- 單一腳本：避免巢狀 script 造成失效 -->
<script>
  // ========= 共用工具 =========
  const R = (n) => Math.round(Number(n) || 0);
  const money = (n) => 'NT$ ' + R(n).toLocaleString('zh-TW');
  const _parseMoney = (s) => Number(String(s||'').replace(/[^\d.-]/g,'')) || 0;

  const API_URL = '/api/save-quote';
  const _toInt = (n) => Math.round(Number(n) || 0);

  function _validateBeforeSave() {
    const basePing = parseFloat(document.getElementById('base_ping').value) || 0;
    if (basePing < 12) throw new Error('請先輸入基準坪數（至少 12 坪）');
    if (!PRICING_STATE.items || PRICING_STATE.items.length === 0) {
      throw new Error('尚未選擇任何項目，沒有可以儲存的明細');
    }
  }

  let bedFrameCount = 0;
  let customItemCount = 0;
  let PRICING_STATE = { items: [], total: 0 };

  document.addEventListener('DOMContentLoaded', () => {
    // 預設今天日期
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    calculatePricing();
  });

  function toggleCustomInput(fieldName) {
    const select = document.getElementById(fieldName);
    const customInput = document.getElementById(fieldName + '_custom');
    if (!select || !customInput) return;
    if (select.value === '其他' || select.value === 'custom') {
      customInput.classList.add('show');
    } else {
      customInput.classList.remove('show');
      customInput.value = '';
    }
  }

  // ===== 動態行元件（通用） =====
  function createPresetSelect(presets, placeholder='請選擇'){
    const sel = document.createElement('select');
    sel.className = 'form-select dyn-name';
    sel.innerHTML = `<option value="">${placeholder}</option>` +
      presets.map((p,i)=>`<option value="p${i}" data-unit="${p.unit||''}" data-price="${p.price||0}">${p.label}</option>`).join('') +
      `<option value="custom">自訂項目</option>`;
    return sel;
  }
  function addDynRow(containerId, presets){
    const wrap = document.getElementById(containerId);
    const row = document.createElement('div');
    row.className = 'row align-items-end g-2 mb-2 dyn-row';

    const colName = document.createElement('div');
    colName.className = 'col-md-3';
    colName.innerHTML = `<label class="form-label">項目</label>`;
    const sel = createPresetSelect(presets);
    const custom = document.createElement('input');
    custom.type = 'text'; custom.className = 'form-control mt-2 dyn-name-custom d-none'; custom.placeholder='輸入名稱';
    colName.appendChild(sel); colName.appendChild(custom);

    const colUnit = document.createElement('div');
    colUnit.className = 'col-md-2';
    colUnit.innerHTML = `<label class="form-label">單位</label><input type="text" class="form-control dyn-unit" placeholder="尺/坪/樘/口">`;

    const colPrice = document.createElement('div');
    colPrice.className = 'col-md-2';
    colPrice.innerHTML = `<label class="form-label">單價</label>
      <div class="input-group"><span class="input-group-text">NT$</span>
      <input type="number" class="form-control dyn-price" min="0" step="1" value="0"></div>`;

    const colQty = document.createElement('div');
    colQty.className = 'col-md-2';
    colQty.innerHTML = `<label class="form-label">數量</label><input type="number" class="form-control dyn-qty" min="0" step="0.1" value="0">`;

    const colAmt = document.createElement('div');
    colAmt.className = 'col-md-2';
    colAmt.innerHTML = `<label class="form-label">金額</label><input type="text" class="form-control dyn-amount auto-calc" readonly>`;

    const colDel = document.createElement('div');
    colDel.className = 'col-md-1';
    colDel.innerHTML = `<button type="button" class="btn btn-outline-danger" title="移除"><i class="fas fa-trash"></i></button>`;

    row.append(colName, colUnit, colPrice, colQty, colAmt, colDel);
    wrap.appendChild(row);

    sel.addEventListener('change', ()=>{
      const opt = sel.options[sel.selectedIndex];
      if (sel.value === 'custom' || sel.value === '') {
        custom.classList.toggle('d-none', sel.value !== 'custom');
      } else {
        custom.classList.add('d-none');
        row.querySelector('.dyn-unit').value  = opt.getAttribute('data-unit') || '';
        row.querySelector('.dyn-price').value = opt.getAttribute('data-price') || 0;
      }
      calculatePricing();
    });
    row.querySelector('.dyn-price').addEventListener('input', calculatePricing);
    row.querySelector('.dyn-qty').addEventListener('input', calculatePricing);
    colDel.querySelector('button').addEventListener('click', ()=>{ row.remove(); calculatePricing(); });
  }

  // ===== 各類別預設清單 =====
  const WOODWORK_PRESETS = [
    { label:'冷氣+窗簾盒', unit:'尺', price:1500 },
    { label:'壁板', unit:'尺', price:4500 },
    { label:'矮屏(無造型)', unit:'尺', price:2500 },
    { label:'矮屏(有弧度)', unit:'尺', price:3000 },
    { label:'拉門(含五金)', unit:'樘', price:33000 },
    { label:'房門(含五金)', unit:'樘', price:33000 },
    { label:'平釘天花板', unit:'坪', price:6500 },
    { label:'造型天花板', unit:'坪', price:7000 },
    { label:'隔間(無造型)', unit:'尺', price:4000 },
    { label:'隔間(有弧度)', unit:'尺', price:5000 },
    { label:'壁掛冷氣凹槽', unit:'空間', price:4500 },
    { label:'吊隱冷氣凹槽', unit:'空間', price:8500 },
    { label:'冷氣出風口 3,000', unit:'口', price:3000 },
    { label:'冷氣出風口 4,000', unit:'口', price:4000 },
    { label:'冷氣出風口 5,000', unit:'口', price:5000 },
    { label:'吊隱維修口', unit:'口', price:4500 },
  ];
  const SYSTEM_PRESETS = [
    { label:'床頭櫃', unit:'尺', price:6000 },
    { label:'吊櫃(有門片)', unit:'尺', price:5500 },
    { label:'吊櫃(無門片)', unit:'尺', price:5000 },
    { label:'高櫃(含書櫃40-50cm無抽屜)', unit:'尺', price:7500 },
    { label:'高櫃(含書櫃40-50cm有抽屜)', unit:'尺', price:8000 },
    { label:'衣櫃(門片含收納櫃60cm)', unit:'尺', price:8500 },
    { label:'衣櫃(拉門含收納櫃60cm)', unit:'尺', price:9000 },
    { label:'電器櫃', unit:'尺', price:8000 },
    { label:'書桌', unit:'尺', price:6000 },
    { label:'矮櫃(無抽屜)', unit:'尺', price:6000 },
    { label:'矮櫃(有抽屜)', unit:'尺', price:7000 },
    { label:'電視櫃', unit:'尺', price:4000 },
    { label:'壁板', unit:'尺', price:3000 },
    // 弧形隔屏
    { label:'弧形隔屏 45cm', unit:'組', price:5000 },
    { label:'弧形隔屏 50cm', unit:'組', price:6000 },
    { label:'弧形隔屏 60cm', unit:'組', price:8000 },
    { label:'弧形隔屏 雙邊', unit:'組', price:12000 },
  ];
  const ALUM_PRESETS = [
    { label:'鋁框吊框 40×70', unit:'樘', price:2300 },
    { label:'鋁框吊框 45×70', unit:'樘', price:2600 },
    { label:'鋁框吊框 50×70', unit:'樘', price:3000 },
  ];
  const TALL_PRESETS = [
    { label:'高門框 40×240', unit:'樘', price:7500 },
    { label:'高門框 45×240', unit:'樘', price:8500 },
    { label:'高門框 50×240', unit:'樘', price:9500 },
  ];

  function addWoodworkItem(){ addDynRow('woodwork-list', WOODWORK_PRESETS); }
  function addSystemItem(){ addDynRow('system-list', SYSTEM_PRESETS); }
  function addAlumItem(){ addDynRow('alum-list', ALUM_PRESETS); }
  function addTallFrameItem(){ addDynRow('tallframe-list', TALL_PRESETS); }

  // ===== 床架 =====
  function addBedFrame() {
    bedFrameCount++;
    const container = document.getElementById('bed-frames-container');
    const bedFrameDiv = document.createElement('div');
    bedFrameDiv.className = 'row mb-3 bed-frame-row';
    bedFrameDiv.innerHTML = `
      <div class="col-3">
        <label class="form-label">床架 ${bedFrameCount}</label>
        <button type="button" class="btn btn-outline-danger btn-sm d-block" onclick="removeBedFrame(this)">
          <i class="fas fa-trash"></i>
        </button>
      </div>
      <div class="col-3">
        <label class="form-label">長(cm)</label>
        <input type="number" class="form-control bed-frame-length" min="0" step="1" value="0" onchange="calculatePricing()">
      </div>
      <div class="col-3">
        <label class="form-label">寬(cm)</label>
        <input type="number" class="form-control bed-frame-width" min="0" step="1" value="0" onchange="calculatePricing()">
      </div>
      <div class="col-3">
        <label class="form-label">金額</label>
        <input type="text" class="form-control bed-frame-total auto-calc" readonly>
      </div>`;
    container.appendChild(bedFrameDiv);
    calculatePricing();
  }
  function removeBedFrame(btn){ btn.closest('.bed-frame-row').remove(); calculatePricing(); }

  // ===== 其他自訂 =====
  function addCustomItem() {
    customItemCount++;
    const c = document.getElementById('custom-items-container');
    const row = document.createElement('div');
    row.className = 'row align-items-end g-2 mb-2 custom-item-row';
    row.innerHTML = `
      <div class="col-md-3"><label class="form-label">項目名稱</label>
        <input type="text" class="form-control ci-name" placeholder="例如：特殊五金"></div>
      <div class="col-md-3"><label class="form-label">單價</label>
        <div class="input-group"><span class="input-group-text">NT$</span>
        <input type="number" class="form-control ci-price" min="0" step="1" value="0" onchange="calculatePricing()"></div></div>
      <div class="col-md-3"><label class="form-label">數量 / 單位</label>
        <div class="input-group">
          <input type="number" class="form-control ci-qty" min="0" step="1" value="0" onchange="calculatePricing()">
          <input type="text" class="form-control ci-unit" placeholder="單位，例如：組">
        </div></div>
      <div class="col-md-2"><label class="form-label">金額</label>
        <input type="text" class="form-control ci-amount auto-calc" readonly></div>
      <div class="col-md-1"><button type="button" class="btn btn-outline-danger" onclick="removeCustomItem(this)"><i class="fas fa-trash"></i></button></div>`;
    c.appendChild(row);
  }
  function removeCustomItem(btn){ btn.closest('.custom-item-row').remove(); calculatePricing(); }

  function getStyleValue() {
    const sel = document.getElementById('style');
    const cus = document.getElementById('style_custom');
    if (sel.value === '其他' && cus.value.trim()) return cus.value.trim();
    return sel.value || '未選擇';
  }
  function getRoomTypeValue() {
    const sel = document.getElementById('room_type');
    const cus = document.getElementById('room_type_custom');
    if (sel.value === '其他' && cus.value.trim()) return cus.value.trim();
    return sel.value || '未選擇';
  }

  // ========= 計算 =========
  function calculatePricing() {
    const totalEl = document.getElementById('total-price');
    const boxEl   = document.getElementById('pricing-breakdown');
    const basePing = parseFloat(document.getElementById('base_ping').value) || 0;

    PRICING_STATE = { items: [], total: 0 };

    const addLine = (category, name, qty, description, rawPrice) => {
      const amt = R(rawPrice);
      if (amt <= 0) return 0;
      PRICING_STATE.items.push({ category, name, qty, description, amount: amt });
      PRICING_STATE.total += amt;
      return amt;
    };

    if (basePing < 12) {
      totalEl.textContent = money(0);
      boxEl.innerHTML = '<p class="text-muted text-center">請先輸入基準坪數（至少 12 坪）</p>';
      ['woodwork_hardware','system_hardware','system_shipping','system_assembly','other_items','supervision_fee','tax']
        .forEach(id=>document.getElementById(id).value = money(0));
      return;
    }

    // ---- 基礎工程（油漆/水電/燈具）
    const baseProjects = [
      { id: 'paint',      name: '油漆',  basePrice: 90000, basePing: 12, increment: 7500 },
      { id: 'electrical', name: '水電',  basePrice: 60000, basePing: 12, increment: 5000 },
      { id: 'lighting',   name: '燈具',  basePrice: 45000, basePing: 12, increment: 3000 }
    ];
    baseProjects.forEach(p => {
      if (document.getElementById(p.id).checked) {
        const raw = p.basePrice + (basePing - p.basePing) * p.increment;
        addLine('基礎工程', p.name, 1, `基數${p.basePrice}+(${basePing}-12)*${p.increment}`, raw);
      }
    });
    // 玻璃固定額度
    const pick = (selId, customId) => {
      const sel = document.getElementById(selId);
      const cus = document.getElementById(customId);
      if (!sel) return 0;
      let v = 0;
      if (sel.value === 'custom' && cus && cus.value) v = parseFloat(cus.value) || 0;
      else v = parseFloat(sel.value) || 0;
      return R(v);
    };
    const glass = pick('glass_select', 'glass_select_custom');
    if (glass > 0) addLine('基礎工程', '玻璃', 1, '選項', glass);

    // ---- 木作工程（動態）
    function collectDyn(containerId, category){
      let sum = 0;
      document.querySelectorAll(`#${containerId} .dyn-row`).forEach(row=>{
        const sel = row.querySelector('.dyn-name');
        const name = sel.value === 'custom'
          ? (row.querySelector('.dyn-name-custom').value.trim() || '自訂項目')
          : (sel.options[sel.selectedIndex]?.text || '項目');
        const unit = (row.querySelector('.dyn-unit').value || '').trim();
        const price = parseFloat(row.querySelector('.dyn-price').value) || 0;
        const qty = parseFloat(row.querySelector('.dyn-qty').value) || 0;
        const amt = R(price * qty);
        row.querySelector('.dyn-amount').value = amt ? amt.toLocaleString('zh-TW') : '';
        if (amt > 0) sum += addLine(category, name, qty, `${qty}${unit?unit:''} × ${price}`, amt) || 0;
      });
      return sum;
    }
    const woodworkTotal = collectDyn('woodwork-list','木作工程');

    // ---- 床架
    let bedFramesSum = 0, idx = 1;
    document.querySelectorAll('.bed-frame-row').forEach(row => {
      const L = parseFloat(row.querySelector('.bed-frame-length').value) || 0;
      const W = parseFloat(row.querySelector('.bed-frame-width').value)  || 0;
      const amt = R(L * W);
      row.querySelector('.bed-frame-total').value = amt ? amt.toLocaleString('zh-TW') : '';
      if (amt > 0) {
        bedFramesSum += addLine('床架', `床架 ${idx++}`, 1, `${L}cm × ${W}cm × 1`, amt) || 0;
      }
    });

    // ---- 系統櫃（動態）
    const systemCatTotal = collectDyn('system-list','系統櫃');
    let systemTotal = systemCatTotal + bedFramesSum;

    // ---- 鐵件拉門
    const ironSlidingDoor = parseFloat(document.getElementById('iron_sliding_door').value) || 0;
    if (ironSlidingDoor > 0) addLine('鐵件拉門', '鐵件拉門(含五金)', ironSlidingDoor, `${ironSlidingDoor}樘 × 28000`, ironSlidingDoor * 28000);

    // ---- 開關面板
    let spPrice = 0, spDesc = '';
    const sp = document.getElementById('switch_panel').value;
    if (sp === 'starlight') { spPrice = 7000 + (basePing - 12) * 600; spDesc = `星光 - 基數7000+(${basePing}-12)*600`; }
    else if (sp === 'risna') { spPrice = 9000 + (basePing - 12) * 700; spDesc = `Risna - 基數9000+(${basePing}-12)*700`; }
    spPrice = R(spPrice);
    document.getElementById('switch_panel_calc').value = money(spPrice);
    addLine('開關面板', '開關面板', 1, spDesc, spPrice);

    // ---- 其他工程
    const largeBoard   = pick('large_board',   'large_board_custom');
    const specialPaint = pick('special_paint', 'special_paint_custom');
    const ironwork     = pick('ironwork',      'ironwork_custom');
    const titaniun     = pick('titanium_strips','titanium_strips_custom');

    if (largeBoard   > 0) addLine('石作工程', '大板',   1, '選項', largeBoard);
    if (specialPaint > 0) addLine('特殊漆工程', '特殊漆', 1, '選項', specialPaint);
    if (ironwork     > 0) addLine('鐵件工程', '鐵件',   1, '選項', ironwork);
    if (titaniun     > 0) addLine('金屬工程', '鈦金條', 1, '選項', titaniun);

    // ---- 其他單價項目
    const misc = [
      { id: 'cleaning',      name: '清潔 (全室含衛浴/陽台/廚房)', price: 1200, unit: '坪' },
      { id: 'wood_flooring', name: '木地板 (不含衛浴/陽台/廚房)', price: 6500, unit: '坪' },
      { id: 'protection',    name: '室內保護',                   price: 1000, unit: '坪' }
    ];
    misc.forEach(i => {
      const v = parseFloat(document.getElementById(i.id).value) || 0;
      if (v > 0) addLine('其他單價項目', i.name, v, `${v}${i.unit} × ${i.price}`, v * i.price);
    });
    const wr = pick('waste_removal', 'waste_removal_custom');
    if (wr > 0) addLine('其他單價項目', '清運', 1, '選項', wr);
    const dm = pick('demolition', 'demolition_custom');
    if (dm > 0) addLine('其他單價項目', '拆除', 1, '選項', dm);

    // ---- 鋁框 / 高門框（動態）
    collectDyn('alum-list','鋁框吊框');
    collectDyn('tallframe-list','高門框');

    // ---- 自訂項目
    document.querySelectorAll('.custom-item-row').forEach(row => {
      const name = row.querySelector('.ci-name').value.trim() || '自訂項目';
      const price = parseFloat(row.querySelector('.ci-price').value) || 0;
      const qty = parseFloat(row.querySelector('.ci-qty').value) || 0;
      const unit = (row.querySelector('.ci-unit').value || '').trim();
      const amt = R(price * qty);
      row.querySelector('.ci-amount').value = amt ? amt.toLocaleString('zh-TW') : '';
      if (amt > 0) addLine('其他自訂', name, qty, `${qty}${unit ? unit : ''} × ${price}`, amt);
    });

    // ---- 自動項目
    const woodworkSub = PRICING_STATE.items.filter(it=>it.category==='木作工程').reduce((s,i)=>s+i.amount,0);
    const woodworkHardware = R(woodworkSub * 0.05);
    document.getElementById('woodwork_hardware').value = money(woodworkHardware);
    addLine('自動項目', '木作五金', 1, '木作小計 × 5%', woodworkHardware);

    const sysHardware = R(systemTotal * 0.05);
    const sysShipping = R(systemTotal * 0.05);
    const sysAssembly = R(systemTotal * 0.20);
    document.getElementById('system_hardware').value = money(sysHardware);
    document.getElementById('system_shipping').value = money(sysShipping);
    document.getElementById('system_assembly').value = money(sysAssembly);
    addLine('自動項目', '系統五金', 1, '系統小計 × 5%',  sysHardware);
    addLine('自動項目', '運費',     1, '系統小計 × 5%',  sysShipping);
    addLine('自動項目', '組裝費',   1, '系統小計 × 20%', sysAssembly);

    const other3 = R(PRICING_STATE.total * 0.03);
    document.getElementById('other_items').value = money(other3);
    addLine('自動項目', '其他項目(3%)', 1, '目前小計 × 3%', other3);

    const supervision = R(PRICING_STATE.total * 0.08);
    document.getElementById('supervision_fee').value = money(supervision);
    addLine('自動項目', '監工費(8%)', 1, '目前小計 × 8%', supervision);

    const tax = R(PRICING_STATE.total * 0.05);
    document.getElementById('tax').value = money(tax);
    addLine('自動項目', '稅額(5%)', 1, '目前小計 × 5%', tax);

    // ---- 更新畫面
    totalEl.textContent = money(PRICING_STATE.total);
    const html = PRICING_STATE.items.length === 0
      ? '<p class="text-muted text-center">請選擇項目來查看明細</p>'
      : PRICING_STATE.items.map(it => `
          <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <span class="fw-medium">${it.category} - ${it.name}</span>
            <span class="text-primary fw-bold">${money(it.amount)}</span>
          </div>`).join('');
    boxEl.innerHTML = html;
  }

  // ========= 匯出（ExcelJS 美化） =========
  // 中文金額
  function ntToChinese(n) {
    const num = Math.round(Number(n) || 0);
    if (num === 0) return '零元整';
    const cnNums = ['零','壹','貳','參','肆','伍','陸','柒','捌','玖'];
    const cnIntRadice = ['','拾','佰','仟'];
    const cnIntUnits = ['','萬','億','兆'];
    let s = '', z = 0, str = String(num);
    for (let i = 0; i < str.length; i++) {
      const n = str.charCodeAt(i) - 48;
      const p = str.length - i - 1, q = Math.floor(p/4), m = p % 4;
      if (n === 0) { z++; if (m === 0 && z < 4) { s += cnIntUnits[q]; z = 0; } }
      else { if (z > 0) s += '零'; z = 0; s += cnNums[n] + cnIntRadice[m]; if (m === 0) s += cnIntUnits[q]; }
    }
    return '新台幣' + s + '元整';
  }
  const CN_ORDER = ['壹','貳','參','肆','伍','陸','柒','捌','玖','拾','拾壹','拾貳','拾參','拾肆','拾伍','拾陸','拾柒','拾捌','拾玖','貳拾'];

  // 從 description 嘗試抓單位
  function guessUnitFromDesc(desc) {
    if (!desc) return '';
    const m = String(desc).match(/^\s*\d+(?:\.\d+)?\s*([^\d×x\* ]+)\s*[×x\*]/);
    return m ? m[1].trim() : '';
  }

  function exportToExcel() {
    calculatePricing();

    const company = '藝瓦室內裝修設計工程股份有限公司';
    const contact = '高 雄 市 鼓 山 區 美 術 東 二 路 80 號                 TEL：07-5866700             FAX：07-5866703';
    const title   = '工 程 預 估';

    const client  = document.getElementById('client_name').value || '';
    const dateISO = document.getElementById('date').value || '';
    const dateStr = dateISO ? (dateISO.replace(/-/g,'/').replace(/^(\d{4})/, (y)=> String(Number(y)-1911))) : '';
    const addr    = document.getElementById('address').value || '';
    const basePing= document.getElementById('base_ping').value || '';

    // 章節對應
    const MAP = {
      '木作工程':'木作工程',
      '床架':'櫃體工程',
      '系統櫃':'櫃體工程',
      '鋁框吊框':'鋁框工程',
      '高門框':'鋁框工程',
      '鐵件拉門':'鋁框工程',
      '石作工程':'石材及大板加工',
      '特殊漆工程':'油漆工程',
      '鐵件工程':'鐵件極鍍鈦工程',
      '金屬工程':'鐵件極鍍鈦工程',
      '其他單價項目':'其他工程',
      '開關面板':'水電工程',
      '自動項目':'自動項目'
    };

    // 排除稅額列（表尾另外列）
    const groups = {};
    (PRICING_STATE.items || []).forEach(it => {
      if (it.category === '自動項目' && /稅額/i.test(it.name)) return;
      const cat = MAP[it.category] || it.category || '其他工程';
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(it);
    });
    // 監工費獨立章節
    const supervisionItem = (PRICING_STATE.items || []).find(i => i.category==='自動項目' && /監工費/i.test(i.name));
    if (supervisionItem) groups['監工費8%~10%'] = [supervisionItem];

    const ORDER = ['木作工程','櫃體工程','天花板工程','油漆工程','水電工程','石材及大板加工','玻璃工程','鐵件極鍍鈦工程','鋁框工程','其他工程','自動項目','監工費8%~10%'];
    const seen = new Set(Object.keys(groups));
    const cats = ORDER.filter(c => seen.has(c)).concat([...seen].filter(c => !ORDER.includes(c)));

    const taxVal  = Math.round(_parseMoney(document.getElementById('tax').value));
    const grand   = Math.round(_parseMoney(document.getElementById('total-price').textContent));
    const subtotal= Math.max(0, grand - taxVal);

    // ExcelJS 建立
    const wb = new ExcelJS.Workbook();
    const ws = wb.addWorksheet('工程預估', { views:[{ state:'frozen', ySplit:6 }] });

    // 欄寬
    ws.columns = [
      { header:'項目', key:'idx', width:6 },
      { header:'名 稱', key:'name', width:40 },
      { header:'數量', key:'qty', width:8 },
      { header:'單位', key:'unit', width:8 },
      { header:'單價', key:'price', width:12 },
      { header:'總價', key:'amount', width:14 },
      { header:'備註', key:'note', width:30 },
    ];

    // 色彩
    const HEADER_FILL = { type:'pattern', pattern:'solid', fgColor:{argb:'FFE0F7FA'} }; // 淺青
    const SECTION_FILL= { type:'pattern', pattern:'solid', fgColor:{argb:'FFEDEDED'} }; // 淺灰
    const FOOT_FILL   = { type:'pattern', pattern:'solid', fgColor:{argb:'FFD1F2F7'} }; // 表尾淺青
    const borderThin  = { style:'thin', color:{argb:'FFAAAAAA'} };

    // 抬頭
    ws.mergeCells('A1:G1'); ws.getCell('A1').value = company;
    ws.mergeCells('A2:G2'); ws.getCell('A2').value = contact;
    ws.mergeCells('A3:G3'); ws.getCell('A3').value = title;
    ws.getCell('A1').font = { size:16, bold:true };
    ws.getCell('A2').font = { size:11 };
    ws.getCell('A3').font = { size:14, bold:true, color:{argb:'FF2C7A7B'} };
    ['A1','A2','A3'].forEach(a=>{ ws.getCell(a).alignment = { horizontal:'center' }; });

    ws.mergeCells('A4:D4'); ws.getCell('A4').value = `業主 : ${client}`;
    ws.mergeCells('E4:G4'); ws.getCell('E4').value = `日期：${dateStr}`;
    ws.mergeCells('A5:D5'); ws.getCell('A5').value = `地址：${addr}`;
    ws.mergeCells('E5:G5'); ws.getCell('E5').value = `坪數：${basePing}`;

    // 表頭列
    const headerRow = ws.addRow(['項目','名 稱','數量','單位','單價','總價','備註']);
    headerRow.eachCell(c=>{ c.fill = HEADER_FILL; c.font = { bold:true }; c.alignment = { horizontal:'center' }; c.border = { top:borderThin, left:borderThin, bottom:borderThin, right:borderThin }; });

    // 內容
    let chapIdx = 0;
    cats.forEach(cat => {
      const list = (groups[cat] || []).filter(it => Math.round(Number(it.amount)||0) > 0);
      if (!list.length) return;

      // 章節列：「壹 、木作工程」
      const s = ws.addRow([`${CN_ORDER[chapIdx]||''} 、${cat}`]);
      chapIdx++;
      s.getCell(1).fill = SECTION_FILL;
      s.getCell(1).font = { bold:true };
      s.getCell(1).alignment = { horizontal:'left' };
      ws.mergeCells(`A${s.number}:G${s.number}`);
      s.getCell(1).border = { top:borderThin, left:borderThin, bottom:borderThin, right:borderThin };

      // 每章節的項目
      let local = 1;
      list.forEach(it => {
        const qty  = Number(it.qty || 0);
        const amt  = Math.round(Number(it.amount)||0);
        // 單位：抓不到就預設「式」，床架用「組」
        const unit = guessUnitFromDesc(it.description) || (it.category==='床架' ? '組' : '式');
        const unitPrice = qty > 0 ? Math.round(amt / qty) : amt;

        const r = ws.addRow([String(local), String(it.name||''), qty || '', unit, unitPrice || '', amt || '', String(it.description||'')]);
        local++;

        // 樣式/邊框
        r.getCell(3).alignment = { horizontal:'right' };
        r.getCell(5).alignment = { horizontal:'right' };
        r.getCell(6).alignment = { horizontal:'right' };
        r.getCell(5).numFmt = '#,##0';
        r.getCell(6).numFmt = '#,##0';
        r.eachCell(c=>{ c.border = { top:borderThin, left:borderThin, bottom:borderThin, right:borderThin }; });
      });
    });

    // 表尾
    ws.addRow([]);
    const rSub = ws.addRow(['','','','小 計:','', subtotal]);
    const rTax = ws.addRow(['','','','稅 額:','', taxVal]);
    const rTot = ws.addRow(['總計:','','','','元正', ntToChinese(grand)]);
    [rSub, rTax, rTot].forEach(r=>{
      r.eachCell((c,idx)=>{
        if (idx>=4) { c.fill = FOOT_FILL; c.border = { top:borderThin, left:borderThin, bottom:borderThin, right:borderThin }; }
        if (idx===6 && typeof c.value === 'number') { c.numFmt = '#,##0'; c.alignment = { horizontal:'right' }; }
        if (idx===5) c.alignment = { horizontal:'center' };
      });
      r.getCell(4).font = { bold:true };
    });

    ws.addRow([]);
    ws.addRow(['◆ 未含主燈/吊燈/壁燈/家具/窗簾/冷氣/陽台工程']);
    ws.addRow(['◆ 未含消防灑水改管/偵煙器移位/緊急壓扣未移/對講機移位工程/全式除濕機/IH爐']);

    // 下載
    wb.xlsx.writeBuffer().then((buf) => {
      const ts = new Date().toISOString().slice(0,19).replace(/[-:T]/g,'');
      saveAs(new Blob([buf], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), `工程預估_${ts}.xlsx`);
    });
  }

  // ========= 儲存到資料庫 =========
  function _collectRawForm(){
    const obj = {};
    document.querySelectorAll('#quotationForm input, #quotationForm select').forEach(el=>{
      if(!el.id) return;
      if(el.type === 'checkbox') obj[el.id] = !!el.checked;
      else obj[el.id] = el.value;
    });
    return obj;
  }
  async function _postPayload(url, payload){
    const bodyText = JSON.stringify(payload);
    const tryOnce = async (ctype) => {
      const resp = await fetch(url, { method:'POST', headers:{ 'Content-Type': ctype, 'Accept':'application/json' }, body: bodyText });
      const text = await resp.text();
      let data = null; try { data = text ? JSON.parse(text) : null; } catch {}
      return { resp, text, data };
    };
    let r = await tryOnce('application/json');
    if (!r.resp.ok && ((r.text || '').includes('Unexpected end of JSON input') || r.resp.status >= 500)) {
      r = await tryOnce('text/plain');
    }
    if (!r.resp.ok) {
      const msg = (r.data && (r.data.error || r.data.message)) || r.text || `HTTP ${r.resp.status}`;
      throw new Error(msg);
    }
    return r.data || { ok:true };
  }
  async function saveQuote(){
    const btn = document.querySelector('button[onclick="saveQuote()"]');
    try{
      if (btn) { btn.disabled = true; btn.textContent = '儲存中…'; }
      calculatePricing();
      _validateBeforeSave();

      const raw   = _collectRawForm();
      const style = getStyleValue();
      const room  = getRoomTypeValue();

      const other3     = _toInt(_parseMoney(document.getElementById('other_items').value));
      const supervise8 = _toInt(_parseMoney(document.getElementById('supervision_fee').value));
      const tax5       = _toInt(_parseMoney(document.getElementById('tax').value));
      const grand      = _toInt(_parseMoney(document.getElementById('total-price').textContent));

      const sanitizedItems = (PRICING_STATE.items || []).map(it => ({
        category: String(it.category || ''),
        name:     String(it.name || ''),
        qty:      Number(it.qty || 0),
        amount:   _toInt(it.amount || 0),
        description: it.description ?? null
      }));

      const quote = {
        quote_date: raw['date'] || null,
        client_name: raw['client_name'] || null,
        address: raw['address'] || null,
        style: style || null,
        room_type: room || null,
        base_ping: Number(raw['base_ping']) || null,
        subtotal: Math.max(0, grand - other3 - supervise8 - tax5),
        other_items: other3,
        supervision_fee: supervise8,
        tax: tax5,
        grand_total: grand,
        form: raw
      };
      const payload = { quote, items: sanitizedItems };
      const data = await _postPayload(API_URL, payload);
      alert('已儲存成功！編號：' + (data?.id || data?.insertedId || '—'));
    }catch(err){
      console.error('SAVE_QUOTE_ERROR:', err);
      alert('儲存失敗：' + (err.message || err));
    }finally{
      if (btn) { btn.disabled = false; btn.textContent = '儲存到資料庫'; }
    }
  }

  // 對外
  window.calculatePricing = calculatePricing;
  window.exportToExcel   = exportToExcel;
  window.saveQuote       = saveQuote;
  window.addBedFrame     = addBedFrame;
  window.removeBedFrame  = removeBedFrame;
  window.addCustomItem   = addCustomItem;
  window.removeCustomItem= removeCustomItem;
  window.addWoodworkItem = addWoodworkItem;
  window.addSystemItem   = addSystemItem;
  window.addAlumItem     = addAlumItem;
  window.addTallFrameItem= addTallFrameItem;
  window.getStyleValue   = getStyleValue;
  window.getRoomTypeValue= getRoomTypeValue;
</script>
</body>
</html>
