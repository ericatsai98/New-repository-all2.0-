<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>室內裝修報價系統 - 完整版</title>
  <!-- 阻止搜尋引擎索引 -->
  <meta name="robots" content="noindex, nofollow">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/darkly/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- SheetJS 官方版本 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; }
    .display-4 { font-weight: 600; color: var(--bs-primary); }
    .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); margin-bottom: 1.5rem; }
    .card-header { background-color: var(--bs-dark); border-bottom: 2px solid var(--bs-primary); font-weight: 600; }
    .form-control:focus, .form-select:focus { border-color: var(--bs-primary); box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25); }
    .pricing-breakdown { animation: fadeIn .3s ease-in; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
    .auto-calc { background-color: rgba(13,110,253,.1); border-color: var(--bs-primary); }
    .input-group-text { background-color: var(--bs-secondary); border-color: var(--bs-border-color); }
    .custom-input { display: none; } .custom-input.show { display: block; }
  </style>

  <!-- 簡易密碼門禁 -->
  <script>
    (function () {
      var pass = prompt("請輸入密碼以訪問報價系統");
      if (pass !== "93784793") {
        document.documentElement.innerHTML = "<!DOCTYPE html><html><head><title>拒絕訪問</title><style>body{font-family:Arial,sans-serif;text-align:center;margin-top:100px;font-size:24px;color:#ff0000;background:#000;}</style></head><body><h1>無權訪問</h1><p>密碼錯誤，拒絕訪問此系統</p></body></html>";
        if (window.stop) window.stop();
        if (document.execCommand) document.execCommand("Stop");
        throw new Error("Access denied");
      }
    })();
  </script>
  <!-- 隱藏頁面內容直到密碼驗證完成 -->
  <style id="hideContent"> body { display: none !important; } </style>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var hideStyle = document.getElementById('hideContent');
      if (hideStyle) hideStyle.remove();
      document.body.style.display = 'block';
    });
  </script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="text-center py-4 mb-4 border-bottom">
      <h1 class="display-4"><i class="fas fa-hammer me-3"></i>室內裝修報價系統</h1>
      <p class="lead text-muted">完整版 - 計算報價並匯出 Excel</p>
    </div>

    <div class="row">
      <!-- Input Form -->
      <div class="col-lg-8">
        <form id="quotationForm">
          <!-- 客戶資訊 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-user me-2"></i>客戶資訊</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="client_name" class="form-label">客戶名稱</label>
                  <input type="text" class="form-control" id="client_name" placeholder="可空白">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="date" class="form-label">報價日期</label>
                  <input type="date" class="form-control" id="date">
                </div>
                <div class="col-12 mb-3">
                  <label for="address" class="form-label">地址</label>
                  <input type="text" class="form-control" id="address" placeholder="可空白">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="style" class="form-label">風格</label>
                  <select class="form-select" id="style" onchange="toggleCustomInput('style')">
                    <option value="">請選擇風格</option>
                    <option value="簡約">簡約</option>
                    <option value="北歐">北歐</option>
                    <option value="清奢">清奢</option>
                    <option value="古典">古典</option>
                    <option value="美式">美式</option>
                    <option value="現代">現代</option>
                    <option value="日式">日式</option>
                    <option value="無印">無印</option>
                    <option value="其他">其他：自行輸入</option>
                  </select>
                  <input type="text" class="form-control mt-2 custom-input" id="style_custom" placeholder="請輸入自訂風格">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="room_type" class="form-label">房型</label>
                  <select class="form-select" id="room_type" onchange="toggleCustomInput('room_type')">
                    <option value="">請選擇房型</option>
                    <option value="一房一廳一衛">一房一廳一衛</option>
                    <option value="兩房一廳一衛">兩房一廳一衛</option>
                    <option value="兩房兩廳兩衛">兩房兩廳兩衛</option>
                    <option value="三房一廳一衛">三房一廳一衛</option>
                    <option value="三房兩廳兩衛">三房兩廳兩衛</option>
                    <option value="三房兩廳三衛">三房兩廳三衛</option>
                    <option value="其他">其他：自行輸入</option>
                  </select>
                  <input type="text" class="form-control mt-2 custom-input" id="room_type_custom" placeholder="請輸入自訂房型">
                </div>
              </div>
            </div>
          </div>

          <!-- 基準坪數 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-ruler me-2"></i>基準坪數</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="base_ping" class="form-label">基準坪數 (12-40坪) *</label>
                  <input type="number" class="form-control" id="base_ping" min="12" max="40" value="20" required onchange="calculatePricing()">
                  <div class="form-text">影響所有基礎工程與區間價格計算</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 基礎工程項目 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-tools me-2"></i>基礎工程項目</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="paint" onchange="calculatePricing()" checked>
                    <label class="form-check-label fw-bold" for="paint">油漆</label>
                    <div><small class="text-muted">基礎價格：90,000元 (12坪)，每坪增額：6,000元</small></div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="electrical" onchange="calculatePricing()" checked>
                    <label class="form-check-label fw-bold" for="electrical">水電</label>
                    <div><small class="text-muted">基礎價格：60,000元 (12坪)，每坪增額：5,000元</small></div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="lighting" onchange="calculatePricing()" checked>
                    <label class="form-check-label fw-bold" for="lighting">燈具</label>
                    <div><small class="text-muted">基礎價格：45,000元 (12坪)，每坪增額：3,000元</small></div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="glass" onchange="calculatePricing()" checked>
                    <label class="form-check-label fw-bold" for="glass">玻璃</label>
                    <div><small class="text-muted">基礎價格：25,000元 (12坪)，每坪增額：3,000元</small></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 木作工程 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-tree me-2"></i>木作工程</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="aircond_woodwork" class="form-label">冷氣+窗簾盒</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="aircond_woodwork" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 1,500</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="wall_panel" class="form-label">壁板</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="wall_panel" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 4,500</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="low_screen_simple" class="form-label">矮屏(無造型)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="low_screen_simple" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 2,500</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="low_screen_curved" class="form-label">矮屏(有弧度)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="low_screen_curved" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 3,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="sliding_door_wood" class="form-label">拉門(含五金)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="sliding_door_wood" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">樘 × 33,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="room_door" class="form-label">房門(含五金)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="room_door" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">樘 × 33,000</span>
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="flat_ceiling" class="form-label">平釘天花板</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="flat_ceiling" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">坪 × 6,500</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="decorative_ceiling" class="form-label">造型天花板</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="decorative_ceiling" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">坪 × 7,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="partition_simple" class="form-label">隔間(無造型)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="partition_simple" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 4,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="partition_curved" class="form-label">隔間(有弧度)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="partition_curved" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 5,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="wall_ac_slot" class="form-label">壁掛冷氣凹槽</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="wall_ac_slot" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">空間 × 4,500</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="ceiling_ac_slot" class="form-label">吊隱冷氣凹槽</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="ceiling_ac_slot" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">空間 × 8,500</span>
                  </div>
                </div>
                <div class="col-12 mb-3">
                  <label for="woodwork_hardware" class="form-label">木作五金 (自動計算 - 木作總金額 × 5%)</label>
                  <input type="text" class="form-control auto-calc" id="woodwork_hardware" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- 系統櫃配置 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-cube me-2"></i>系統櫃配置</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                系統櫃以「尺」計價；<b>床架以公分計價（長cm × 寬cm）</b>
              </div>
              <div class="row">
                <div class="col-12 mb-3">
                  <label class="form-label fw-bold">床架配置 (長cm × 寬cm = 金額)</label>
                  <div class="card bg-secondary">
                    <div class="card-body">
                      <div id="bed-frames-container"><!-- 動態床架 --></div>
                      <button type="button" class="btn btn-outline-primary btn-sm" onclick="addBedFrame()">
                        <i class="fas fa-plus me-1"></i>新增床架
                      </button>
                    </div>
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="nightstand" class="form-label">床頭櫃</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="nightstand" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 6,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="wall_cabinet_door" class="form-label">吊櫃(有門片)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="wall_cabinet_door" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 5,500</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="wall_cabinet_no_door" class="form-label">吊櫃(無門片)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="wall_cabinet_no_door" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 5,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="tall_cabinet_no_drawer" class="form-label">高櫃(含書櫃40-50cm無抽屜)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="tall_cabinet_no_drawer" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 7,500</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="tall_cabinet_with_drawer" class="form-label">高櫃(含書櫃40-50cm有抽屜)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="tall_cabinet_with_drawer" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 8,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="wardrobe_door_60cm" class="form-label">衣櫃(門片含收納櫃60cm)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="wardrobe_door_60cm" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 8,500</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="wardrobe_slide_60cm" class="form-label">衣櫃(拉門含收納櫃60cm)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="wardrobe_slide_60cm" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 9,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="appliance_cabinet" class="form-label">電器櫃</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="appliance_cabinet" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 8,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="desk" class="form-label">書桌</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="desk" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 6,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="low_cabinet_no_drawer" class="form-label">矮櫃(無抽屜)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="low_cabinet_no_drawer" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 6,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="low_cabinet_with_drawer" class="form-label">矮櫃(有抽屜)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="low_cabinet_with_drawer" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 7,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="tv_cabinet" class="form-label">電視櫃</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="tv_cabinet" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 4,000</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="system_wall_panel" class="form-label">壁板</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="system_wall_panel" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">尺 × 3,000</span>
                  </div>
                </div>

                <div class="col-12 mb-3">
                  <label for="system_hardware" class="form-label">系統五金 (自動計算 - 系統總金額 × 5%)</label>
                  <input type="text" class="form-control auto-calc" id="system_hardware" readonly>
                </div>
                <div class="col-12 mb-3">
                  <label for="system_shipping" class="form-label">運費 (自動計算 - 系統總金額 × 5%)</label>
                  <input type="text" class="form-control auto-calc" id="system_shipping" readonly>
                </div>
                <div class="col-12 mb-3">
                  <label for="system_assembly" class="form-label">組裝費 (自動計算 - 系統總金額 × 20%)</label>
                  <input type="text" class="form-control auto-calc" id="system_assembly" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- 鐵件拉門 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-door-open me-2"></i>鐵件拉門</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="iron_sliding_door" class="form-label">鐵件拉門(含五金)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="iron_sliding_door" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">樘 × 28,000</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 開關面板 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-toggle-on me-2"></i>開關面板</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="switch_panel" class="form-label">選擇開關面板</label>
                  <select class="form-select" id="switch_panel" onchange="calculatePricing()">
                    <option value="starlight" selected>星光 - 基數7000 每坪+600</option>
                    <option value="risna">Risna - 基數9000 每坪+700</option>
                  </select>
                  <small class="text-muted">基數為12坪，每多1坪按對應金額計算</small>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="switch_panel_calc" class="form-label">開關面板金額 (自動計算)</label>
                  <input type="text" class="form-control auto-calc" id="switch_panel_calc" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- 石作工程 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-square me-2"></i>石作工程</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="large_board" class="form-label">大板</label>
                  <select class="form-select" id="large_board" onchange="toggleCustomInput('large_board'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="60000">一般 - 60,000</option>
                    <option value="120000">貴一點 - 120,000</option>
                    <option value="200000">最貴 - 200,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input type="number" class="form-control mt-2 custom-input" id="large_board_custom" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
              </div>
            </div>
          </div>

          <!-- 特殊漆工程 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-paint-roller me-2"></i>特殊漆工程</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="special_paint" class="form-label">特殊漆</label>
                  <select class="form-select" id="special_paint" onchange="toggleCustomInput('special_paint'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="50000">一般 - 50,000</option>
                    <option value="100000">貴一點 - 100,000</option>
                    <option value="150000">最貴 - 150,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input type="number" class="form-control mt-2 custom-input" id="special_paint_custom" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
              </div>
            </div>
          </div>

          <!-- 鐵件工程 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-tools me-2"></i>鐵件工程</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="ironwork" class="form-label">鐵件</label>
                  <select class="form-select" id="ironwork" onchange="toggleCustomInput('ironwork'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="40000">一般 - 40,000</option>
                    <option value="80000">貴一點 - 80,000</option>
                    <option value="120000">最貴 - 120,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input type="number" class="form-control mt-2 custom-input" id="ironwork_custom" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
              </div>
            </div>
          </div>

          <!-- 金屬工程 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-cogs me-2"></i>金屬工程</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="titanium_strips" class="form-label">鈦金條</label>
                  <select class="form-select" id="titanium_strips" onchange="toggleCustomInput('titanium_strips'); calculatePricing()">
                    <option value="0">不選擇</option>
                    <option value="10000">少-4條 - 10,000</option>
                    <option value="15000">中-6條 - 15,000</option>
                    <option value="20000">多-8條 - 20,000</option>
                    <option value="custom">自行輸入金額</option>
                  </select>
                  <input type="number" class="form-control mt-2 custom-input" id="titanium_strips_custom" placeholder="請輸入金額" onchange="calculatePricing()">
                </div>
              </div>
            </div>
          </div>

          <!-- 鋁框吊框 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-window-maximize me-2"></i>鋁框吊框</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="aluminum_40x70" class="form-label">40*70</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="aluminum_40x70" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">樘 × 2,300</span>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="aluminum_45x70" class="form-label">45*70</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="aluminum_45x70" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">樘 × 2,600</span>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="aluminum_50x70" class="form-label">50*70</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="aluminum_50x70" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">樘 × 3,000</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 高門框 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-door-closed me-2"></i>高門框</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="tall_frame_40x240" class="form-label">40*240</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="tall_frame_40x240" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">樘 × 7,500</span>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="tall_frame_45x240" class="form-label">45*240</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="tall_frame_45x240" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">樘 × 8,500</span>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="tall_frame_50x240" class="form-label">50*240</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="tall_frame_50x240" min="0" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">樘 × 9,500</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 其他單價項目 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>其他單價項目</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="cleaning" class="form-label">清潔 (全室含衛浴/陽台/廚房)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="cleaning" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">坪 × 1,200</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="wood_flooring" class="form-label">木地板 (不含衛浴/陽台/廚房)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="wood_flooring" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">坪 × 6,500</span>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="protection" class="form-label">室內保護</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="protection" min="0" step="0.1" value="0" onchange="calculatePricing()">
                    <span class="input-group-text">坪 × 1,000</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 其他項目（尚未計算的項目） -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-plus me-2"></i>其他項目 (尚未計算的項目)</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-12 mb-3">
                  <label for="other_items" class="form-label">其他項目 (自動計算 - 總金額 × 10%)</label>
                  <input type="text" class="form-control auto-calc" id="other_items" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- 監工費和稅額 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><i class="fas fa-calculator me-2"></i>費用計算</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="supervision_fee" class="form-label">監工費 (自動計算 - 8%)</label>
                  <input type="text" class="form-control auto-calc" id="supervision_fee" readonly>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="tax" class="form-label">稅額 (自動計算 - 5%)</label>
                  <input type="text" class="form-control auto-calc" id="tax" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- 計算結果 -->
          <div class="row">
            <div class="col-12">
              <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary btn-lg" onclick="calculatePricing()">
                  <i class="fas fa-calculator me-2"></i>重新計算報價
                </button>
                <button type="button" class="btn btn-success btn-lg" onclick="exportToExcel()">
                  <i class="fas fa-download me-2"></i>匯出 Excel 報價單
                </button>
                <button type="button" class="btn btn-outline-primary btn-lg" onclick="saveQuote()">
                  <i class="fas fa-cloud-upload-alt me-2"></i>儲存到資料庫
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- 價格顯示區域 -->
      <div class="col-lg-4">
        <div class="sticky-top" style="top: 2rem;">
          <!-- 總價顯示 -->
          <div class="card mb-4">
            <div class="card-header text-center">
              <h5 class="card-title mb-0">
                <i class="fas fa-dollar-sign me-2"></i>總報價
              </h5>
            </div>
            <div class="card-body text-center">
              <h2 class="display-5 text-primary fw-bold" id="total-price">NT$ 0</h2>
            </div>
          </div>

          <!-- 價格明細 -->
          <div class="card">
            <div class="card-header">
              <h6 class="card-title mb-0">
                <i class="fas fa-list-ul me-2"></i>價格明細
              </h6>
            </div>
            <div class="card-body">
              <div id="pricing-breakdown" class="pricing-breakdown">
                <p class="text-muted text-center">請選擇項目來查看明細</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let bedFrameCount = 0;

    // 初始化日期
    document.addEventListener('DOMContentLoaded', function () {
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];
      document.getElementById('date').value = formattedDate;
      calculatePricing();
    });

    function toggleCustomInput(fieldName) {
      const select = document.getElementById(fieldName);
      const customInput = document.getElementById(fieldName + '_custom');

      if (select.value === '其他') {
        customInput.classList.add('show');
      } else {
        customInput.classList.remove('show');
        customInput.value = '';
      }

      if (select.value === 'custom') {
        customInput.classList.add('show');
      } else if (fieldName !== 'style' && fieldName !== 'room_type') {
        customInput.classList.remove('show');
        customInput.value = '';
      }
    }

    function addBedFrame() {
      bedFrameCount++;
      const container = document.getElementById('bed-frames-container');
      const bedFrameDiv = document.createElement('div');
      bedFrameDiv.className = 'row mb-3 bed-frame-row';
      bedFrameDiv.innerHTML = `
        <div class="col-3">
          <label class="form-label">床架 ${bedFrameCount}</label>
          <button type="button" class="btn btn-outline-danger btn-sm d-block" onclick="removeBedFrame(this)">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="col-3">
          <label class="form-label">長(cm)</label>
          <input type="number" class="form-control bed-frame-length" min="0" step="1" value="0" onchange="calculatePricing()">
        </div>
        <div class="col-3">
          <label class="form-label">寬(cm)</label>
          <input type="number" class="form-control bed-frame-width" min="0" step="1" value="0" onchange="calculatePricing()">
        </div>
        <div class="col-3">
          <label class="form-label">金額</label>
          <input type="text" class="form-control bed-frame-total auto-calc" readonly>
        </div>
      `;
      container.appendChild(bedFrameDiv);
      calculatePricing();
    }

    function removeBedFrame(button) {
      button.closest('.bed-frame-row').remove();
      calculatePricing();
    }

    function getStyleValue() {
      const styleSelect = document.getElementById('style');
      const customInput = document.getElementById('style_custom');
      if (styleSelect.value === '其他' && customInput.value.trim()) {
        return customInput.value.trim();
      }
      return styleSelect.value || '未選擇';
    }

    function getRoomTypeValue() {
      const roomTypeSelect = document.getElementById('room_type');
      const customInput = document.getElementById('room_type_custom');
      if (roomTypeSelect.value === '其他' && customInput.value.trim()) {
        return customInput.value.trim();
      }
      return roomTypeSelect.value || '未選擇';
    }

    function calculatePricing() {
      const basePing = parseFloat(document.getElementById('base_ping').value) || 0;
if (basePing < 12) {
  const totalEl = document.getElementById('total-price');
  const boxEl   = document.getElementById('pricing-breakdown');
  if (totalEl) totalEl.textContent = 'NT$ 0';
  if (boxEl)   boxEl.innerHTML = '<p class="text-muted text-center">請先輸入基準坪數（至少 12 坪）</p>';
  return;
}


      let breakdown = [];
      let total = 0;

      // 基礎工程
      const baseProjects = [
        { id: 'paint', name: '油漆', basePrice: 90000, basePing: 12, increment: 6000 },
        { id: 'electrical', name: '水電', basePrice: 60000, basePing: 12, increment: 5000 },
        { id: 'lighting', name: '燈具', basePrice: 45000, basePing: 12, increment: 3000 },
        { id: 'glass', name: '玻璃', basePrice: 25000, basePing: 12, increment: 3000 }
      ];
      baseProjects.forEach(project => {
        if (document.getElementById(project.id).checked) {
          const price = project.basePrice + (basePing - project.basePing) * project.increment;
          breakdown.push({ name: project.name, price });
          total += price;
        }
      });

      // 木作工程
      const woodworkItems = [
        { id: 'aircond_woodwork', name: '冷氣+窗簾盒', price: 1500 },
        { id: 'wall_panel', name: '壁板', price: 4500 },
        { id: 'low_screen_simple', name: '矮屏(無造型)', price: 2500 },
        { id: 'low_screen_curved', name: '矮屏(有弧度)', price: 3000 },
        { id: 'sliding_door_wood', name: '拉門(含五金)', price: 33000 },
        { id: 'room_door', name: '房門(含五金)', price: 33000 },
        { id: 'flat_ceiling', name: '平釘天花板', price: 6500 },
        { id: 'decorative_ceiling', name: '造型天花板', price: 7000 },
        { id: 'partition_simple', name: '隔間(無造型)', price: 4000 },
        { id: 'partition_curved', name: '隔間(有弧度)', price: 5000 },
        { id: 'wall_ac_slot', name: '壁掛冷氣凹槽', price: 4500 },
        { id: 'ceiling_ac_slot', name: '吊隱冷氣凹槽', price: 8500 }
      ];
      let woodworkTotal = 0;
      woodworkItems.forEach(item => {
        const value = parseFloat(document.getElementById(item.id).value) || 0;
        if (value > 0) {
          const itemTotal = value * item.price;
          breakdown.push({ name: item.name, price: itemTotal });
          total += itemTotal;
          woodworkTotal += itemTotal;
        }
      });

      // 床架（cm × cm × 1）
      let bedFramesSum = 0;
      const bedFrames = document.querySelectorAll('.bed-frame-row');
      bedFrames.forEach((frame, index) => {
        const length = parseFloat(frame.querySelector('.bed-frame-length').value) || 0;
        const width  = parseFloat(frame.querySelector('.bed-frame-width').value)  || 0;
        const bedFrameTotal = length * width; // 1 元/平方公分
        frame.querySelector('.bed-frame-total').value = bedFrameTotal.toLocaleString();
        if (bedFrameTotal > 0) {
          breakdown.push({ name: `床架 ${index + 1}`, price: bedFrameTotal });
          total += bedFrameTotal;
          bedFramesSum += bedFrameTotal;
        }
      });

      // 系統櫃
      const systemItems = [
        { id: 'nightstand', name: '床頭櫃', price: 6000 },
        { id: 'wall_cabinet_door', name: '吊櫃(有門片)', price: 5500 },
        { id: 'wall_cabinet_no_door', name: '吊櫃(無門片)', price: 5000 },
        { id: 'tall_cabinet_no_drawer', name: '高櫃(含書櫃40-50cm無抽屜)', price: 7500 },
        { id: 'tall_cabinet_with_drawer', name: '高櫃(含書櫃40-50cm有抽屜)', price: 8000 },
        { id: 'wardrobe_door_60cm', name: '衣櫃(門片含收納櫃60cm)', price: 8500 },
        { id: 'wardrobe_slide_60cm', name: '衣櫃(拉門含收納櫃60cm)', price: 9000 },
        { id: 'appliance_cabinet', name: '電器櫃', price: 8000 },
        { id: 'desk', name: '書桌', price: 6000 },
        { id: 'low_cabinet_no_drawer', name: '矮櫃(無抽屜)', price: 6000 },
        { id: 'low_cabinet_with_drawer', name: '矮櫃(有抽屜)', price: 7000 },
        { id: 'tv_cabinet', name: '電視櫃', price: 4000 },
        { id: 'system_wall_panel', name: '壁板', price: 3000 }
      ];
      let systemTotal = 0;
      systemItems.forEach(item => {
        const value = parseFloat(document.getElementById(item.id).value) || 0;
        if (value > 0) {
          const itemTotal = value * item.price;
          breakdown.push({ name: item.name, price: itemTotal });
          total += itemTotal;
          systemTotal += itemTotal;
        }
      });
      // 關鍵：把床架金額併入系統櫃總額
      systemTotal += bedFramesSum;

      // 鐵件拉門
      const ironSlidingDoorValue = parseFloat(document.getElementById('iron_sliding_door').value) || 0;
      if (ironSlidingDoorValue > 0) {
        const ironSlidingDoorTotal = ironSlidingDoorValue * 28000;
        breakdown.push({ name: '鐵件拉門(含五金)', price: ironSlidingDoorTotal });
        total += ironSlidingDoorTotal;
      }

      // 開關面板
      const switchPanel = document.getElementById('switch_panel').value;
      let switchPanelPrice = 0;
      if (switchPanel === 'starlight') switchPanelPrice = 7000 + (basePing - 12) * 600;
      else if (switchPanel === 'risna') switchPanelPrice = 9000 + (basePing - 12) * 700;
      document.getElementById('switch_panel_calc').value = `NT$ ${switchPanelPrice.toLocaleString()}`;
      breakdown.push({ name: '開關面板', price: switchPanelPrice });
      total += switchPanelPrice;

      // 特殊工程
      const largeBoardSelect = document.getElementById('large_board');
      const largeBoardCustom = document.getElementById('large_board_custom');
      let largeBoardPrice = 0;
      if (largeBoardSelect.value === 'custom' && largeBoardCustom.value) largeBoardPrice = parseFloat(largeBoardCustom.value) || 0;
      else largeBoardPrice = parseFloat(largeBoardSelect.value) || 0;
      if (largeBoardPrice > 0) { breakdown.push({ name: '石作工程-大板', price: largeBoardPrice }); total += largeBoardPrice; }

      const specialPaintSelect = document.getElementById('special_paint');
      const specialPaintCustom = document.getElementById('special_paint_custom');
      let specialPaintPrice = 0;
      if (specialPaintSelect.value === 'custom' && specialPaintCustom.value) specialPaintPrice = parseFloat(specialPaintCustom.value) || 0;
      else specialPaintPrice = parseFloat(specialPaintSelect.value) || 0;
      if (specialPaintPrice > 0) { breakdown.push({ name: '特殊漆工程-特殊漆', price: specialPaintPrice }); total += specialPaintPrice; }

      const ironworkSelect = document.getElementById('ironwork');
      const ironworkCustom = document.getElementById('ironwork_custom');
      let ironworkPrice = 0;
      if (ironworkSelect.value === 'custom' && ironworkCustom.value) ironworkPrice = parseFloat(ironworkCustom.value) || 0;
      else ironworkPrice = parseFloat(ironworkSelect.value) || 0;
      if (ironworkPrice > 0) { breakdown.push({ name: '鐵件工程-鐵件', price: ironworkPrice }); total += ironworkPrice; }

      const titaniumStripsSelect = document.getElementById('titanium_strips');
      const titaniumStripsCustom = document.getElementById('titanium_strips_custom');
      let titaniumStripsPrice = 0;
      if (titaniumStripsSelect.value === 'custom' && titaniumStripsCustom.value) titaniumStripsPrice = parseFloat(titaniumStripsCustom.value) || 0;
      else titaniumStripsPrice = parseFloat(titaniumStripsSelect.value) || 0;
      if (titaniumStripsPrice > 0) { breakdown.push({ name: '金屬工程-鈦金條', price: titaniumStripsPrice }); total += titaniumStripsPrice; }

      // 其他單價項目
      const miscItems = [
        { id: 'cleaning', name: '清潔 (全室含衛浴/陽台/廚房)', price: 1200 },
        { id: 'wood_flooring', name: '木地板 (不含衛浴/陽台/廚房)', price: 6500 },
        { id: 'protection', name: '室內保護', price: 1000 }
      ];
      miscItems.forEach(item => {
        const value = parseFloat(document.getElementById(item.id).value) || 0;
        if (value > 0) {
          const itemTotal = value * item.price;
          breakdown.push({ name: item.name, price: itemTotal });
          total += itemTotal;
        }
      });

      // 其他項目（鋁框吊框 / 高門框）
      const otherItems = [
        { id: 'aluminum_40x70', name: '鋁框吊框 40*70', price: 2300 },
        { id: 'aluminum_45x70', name: '鋁框吊框 45*70', price: 2600 },
        { id: 'aluminum_50x70', name: '鋁框吊框 50*70', price: 3000 },
        { id: 'tall_frame_40x240', name: '高門框 40*240', price: 7500 },
        { id: 'tall_frame_45x240', name: '高門框 45*240', price: 8500 },
        { id: 'tall_frame_50x240', name: '高門框 50*240', price: 9500 }
      ];
      otherItems.forEach(item => {
        const value = parseFloat(document.getElementById(item.id).value) || 0;
        if (value > 0) {
          const itemTotal = value * item.price;
          breakdown.push({ name: item.name, price: itemTotal });
          total += itemTotal;
        }
      });

      // 自動項目：木作五金 5%
      const woodworkHardware = woodworkTotal * 0.05;
      document.getElementById('woodwork_hardware').value = `NT$ ${woodworkHardware.toLocaleString()}`;
      if (woodworkHardware > 0) { breakdown.push({ name: '木作五金', price: woodworkHardware }); total += woodworkHardware; }

      // 自動項目：系統五金/運費/組裝（包含床架）
      const systemHardware = systemTotal * 0.05;
      const systemShipping = systemTotal * 0.05;
      const systemAssembly = systemTotal * 0.20;
      document.getElementById('system_hardware').value = `NT$ ${systemHardware.toLocaleString()}`;
      document.getElementById('system_shipping').value = `NT$ ${systemShipping.toLocaleString()}`;
      document.getElementById('system_assembly').value = `NT$ ${systemAssembly.toLocaleString()}`;
      if (systemHardware > 0) { breakdown.push({ name: '系統五金', price: systemHardware }); total += systemHardware; }
      if (systemShipping > 0) { breakdown.push({ name: '運費', price: systemShipping }); total += systemShipping; }
      if (systemAssembly > 0) { breakdown.push({ name: '組裝費', price: systemAssembly }); total += systemAssembly; }

      // 自動項目：其他項目 10%
      const otherItemsAmount = total * 0.10;
      document.getElementById('other_items').value = `NT$ ${otherItemsAmount.toLocaleString()}`;
      if (otherItemsAmount > 0) { breakdown.push({ name: '其他項目', price: otherItemsAmount }); total += otherItemsAmount; }

      // 自動項目：監工費 8%
      const supervisionFee = total * 0.08;
      document.getElementById('supervision_fee').value = `NT$ ${supervisionFee.toLocaleString()}`;
      if (supervisionFee > 0) { breakdown.push({ name: '監工費', price: supervisionFee }); total += supervisionFee; }

      // 自動項目：稅額 5%
      const tax = total * 0.05;
      document.getElementById('tax').value = `NT$ ${tax.toLocaleString()}`;
      if (tax > 0) { breakdown.push({ name: '稅額', price: tax }); total += tax; }

      // 更新顯示
      updatePricingDisplay(breakdown, total);
    }

    function updatePricingDisplay(breakdown, total) {
      const totalElement = document.getElementById('total-price');
      const container = document.getElementById('pricing-breakdown');

      let html = '';
      if (breakdown.length === 0) {
        html = '<p class="text-muted text-center">請選擇項目來查看明細</p>';
      } else {
        breakdown.forEach(item => {
          html += `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
              <span class="fw-medium">${item.name}</span>
              <span class="text-primary fw-bold">NT$ ${item.price.toLocaleString()}</span>
            </div>
          `;
        });
      }

      container.innerHTML = html;
      totalElement.textContent = `NT$ ${total.toLocaleString()}`;
    }

    function exportToExcel() {
      // ===== 客戶資料 =====
      const clientData = [
        ["客戶名稱", document.getElementById('client_name').value || '未填寫'],
        ["報價日期", document.getElementById('date').value || '未填寫'],
        ["地址", document.getElementById('address').value || '未填寫'],
        ["風格", getStyleValue()],
        ["房型", getRoomTypeValue()],
        ["基準坪數", document.getElementById('base_ping').value || '0']
      ];
      const basePing = parseFloat(document.getElementById('base_ping').value) || 0;

      // ===== 逐步累加，確保與畫面總價一致（計算順序相同） =====
      const items = [];
      let total = 0;

      // 基礎工程
      const baseProjects = [
        { id: 'paint', name: '油漆', category: '基礎工程', basePrice: 90000, basePing: 12, increment: 6000 },
        { id: 'electrical', name: '水電', category: '基礎工程', basePrice: 60000, basePing: 12, increment: 5000 },
        { id: 'lighting', name: '燈具', category: '基礎工程', basePrice: 45000, basePing: 12, increment: 3000 },
        { id: 'glass', name: '玻璃', category: '基礎工程', basePrice: 25000, basePing: 12, increment: 3000 }
      ];
      baseProjects.forEach(p => {
        if (document.getElementById(p.id).checked) {
          const price = p.basePrice + (basePing - p.basePing) * p.increment;
          items.push([p.category, p.name, 1, `基數${p.basePrice}+(${basePing}-12)*${p.increment}`, price]);
          total += price;
        }
      });

      // 木作工程
      const woodworkItems = [
        { id: 'aircond_woodwork', name: '冷氣+窗簾盒', category: '木作工程', price: 1500, unit: '尺' },
        { id: 'wall_panel', name: '壁板', category: '木作工程', price: 4500, unit: '尺' },
        { id: 'low_screen_simple', name: '矮屏(無造型)', category: '木作工程', price: 2500, unit: '尺' },
        { id: 'low_screen_curved', name: '矮屏(有弧度)', category: '木作工程', price: 3000, unit: '尺' },
        { id: 'sliding_door_wood', name: '拉門(含五金)', category: '木作工程', price: 33000, unit: '樘' },
        { id: 'room_door', name: '房門(含五金)', category: '木作工程', price: 33000, unit: '樘' },
        { id: 'flat_ceiling', name: '平釘天花板', category: '木作工程', price: 6500, unit: '坪' },
        { id: 'decorative_ceiling', name: '造型天花板', category: '木作工程', price: 7000, unit: '坪' },
        { id: 'partition_simple', name: '隔間(無造型)', category: '木作工程', price: 4000, unit: '尺' },
        { id: 'partition_curved', name: '隔間(有弧度)', category: '木作工程', price: 5000, unit: '尺' },
        { id: 'wall_ac_slot', name: '壁掛冷氣凹槽', category: '木作工程', price: 4500, unit: '空間' },
        { id: 'ceiling_ac_slot', name: '吊隱冷氣凹槽', category: '木作工程', price: 8500, unit: '空間' }
      ];
      let woodworkTotal = 0;
      woodworkItems.forEach(item => {
        const value = parseFloat(document.getElementById(item.id).value) || 0;
        if (value > 0) {
          const amt = value * item.price;
          items.push([item.category, item.name, value, `${value}${item.unit} × ${item.price}`, amt]);
          total += amt;
          woodworkTotal += amt;
        }
      });

      // 床架（cm × cm × 1）
      const bedRows = document.querySelectorAll('.bed-frame-row');
      let bfIdx = 1;
      let bedFramesSum = 0;
      bedRows.forEach(row => {
        const L = parseFloat(row.querySelector('.bed-frame-length').value) || 0;
        const W = parseFloat(row.querySelector('.bed-frame-width').value) || 0;
        const amt = L * W;
        if (amt > 0) {
          items.push(['床架', `床架 ${bfIdx++}`, 1, `${L}cm × ${W}cm × 1`, amt]);
          total += amt;
          bedFramesSum += amt;
        }
      });

      // 系統櫃
      const systemItems = [
        { id: 'nightstand', name: '床頭櫃', category: '系統櫃', price: 6000, unit: '尺' },
        { id: 'wall_cabinet_door', name: '吊櫃(有門片)', category: '系統櫃', price: 5500, unit: '尺' },
        { id: 'wall_cabinet_no_door', name: '吊櫃(無門片)', category: '系統櫃', price: 5000, unit: '尺' },
        { id: 'tall_cabinet_no_drawer', name: '高櫃(含書櫃40-50cm無抽屜)', category: '系統櫃', price: 7500, unit: '尺' },
        { id: 'tall_cabinet_with_drawer', name: '高櫃(含書櫃40-50cm有抽屜)', category: '系統櫃', price: 8000, unit: '尺' },
        { id: 'wardrobe_door_60cm', name: '衣櫃(門片含收納櫃60cm)', category: '系統櫃', price: 8500, unit: '尺' },
        { id: 'wardrobe_slide_60cm', name: '衣櫃(拉門含收納櫃60cm)', category: '系統櫃', price: 9000, unit: '尺' },
        { id: 'appliance_cabinet', name: '電器櫃', category: '系統櫃', price: 8000, unit: '尺' },
        { id: 'desk', name: '書桌', category: '系統櫃', price: 6000, unit: '尺' },
        { id: 'low_cabinet_no_drawer', name: '矮櫃(無抽屜)', category: '系統櫃', price: 6000, unit: '尺' },
        { id: 'low_cabinet_with_drawer', name: '矮櫃(有抽屜)', category: '系統櫃', price: 7000, unit: '尺' },
        { id: 'tv_cabinet', name: '電視櫃', category: '系統櫃', price: 4000, unit: '尺' },
        { id: 'system_wall_panel', name: '壁板', category: '系統櫃', price: 3000, unit: '尺' }
      ];
      let systemTotal = 0;
      systemItems.forEach(item => {
        const value = parseFloat(document.getElementById(item.id).value) || 0;
        if (value > 0) {
          const amt = value * item.price;
          items.push([item.category, item.name, value, `${value}${item.unit} × ${item.price}`, amt]);
          total += amt;
          systemTotal += amt;
        }
      });
      // 把床架併入系統櫃總額（影響五金/運費/組裝）
      systemTotal += bedFramesSum;

      // 鐵件拉門
      const ironSlidingDoorValue = parseFloat(document.getElementById('iron_sliding_door').value) || 0;
      if (ironSlidingDoorValue > 0) {
        const amt = ironSlidingDoorValue * 28000;
        items.push(['鐵件拉門', '鐵件拉門(含五金)', ironSlidingDoorValue, `${ironSlidingDoorValue}樘 × 28000`, amt]);
        total += amt;
      }

      // 開關面板
      const sp = document.getElementById('switch_panel').value;
      let spPrice = 0, spDesc = '';
      if (sp === 'starlight') {
        spPrice = 7000 + (basePing - 12) * 600;
        spDesc = `星光 - 基數7000+(${basePing}-12)*600`;
      } else if (sp === 'risna') {
        spPrice = 9000 + (basePing - 12) * 700;
        spDesc = `Risna - 基數9000+(${basePing}-12)*700`;
      }
      items.push(['開關面板', '開關面板', 1, spDesc, spPrice]);
      total += spPrice;

      // 特殊工程
      const addSelectItem = (selId, customId, cat, name) => {
        const sel = document.getElementById(selId);
        const custom = document.getElementById(customId);
        let price = 0, desc = '';
        if (sel.value === 'custom' && custom.value) { price = parseFloat(custom.value) || 0; desc = '自訂金額'; }
        else if (sel.value !== '0') { price = parseFloat(sel.value) || 0; desc = sel.options[sel.selectedIndex].text; }
        if (price > 0) { items.push([cat, name, 1, desc, price]); total += price; }
      };
      addSelectItem('large_board', 'large_board_custom', '石作工程', '大板');
      addSelectItem('special_paint', 'special_paint_custom', '特殊漆工程', '特殊漆');
      addSelectItem('ironwork', 'ironwork_custom', '鐵件工程', '鐵件');
      addSelectItem('titanium_strips', 'titanium_strips_custom', '金屬工程', '鈦金條');

      // 其他單價項目
      const miscForExcel = [
        { id: 'cleaning', name: '清潔 (全室含衛浴/陽台/廚房)', category: '其他單價項目', price: 1200, unit: '坪' },
        { id: 'wood_flooring', name: '木地板 (不含衛浴/陽台/廚房)', category: '其他單價項目', price: 6500, unit: '坪' },
        { id: 'protection', name: '室內保護', category: '其他單價項目', price: 1000, unit: '坪' }
      ];
      miscForExcel.forEach(item => {
        const value = parseFloat(document.getElementById(item.id).value) || 0;
        if (value > 0) {
          const amt = value * item.price;
          items.push([item.category, item.name, value, `${value}${item.unit} × ${item.price}`, amt]);
          total += amt;
        }
      });

      // 鋁框吊框 / 高門框
      const othersForExcel = [
        { id: 'aluminum_40x70', name: '鋁框吊框 40*70', category: '鋁框吊框', price: 2300, unit: '樘' },
        { id: 'aluminum_45x70', name: '鋁框吊框 45*70', category: '鋁框吊框', price: 2600, unit: '樘' },
        { id: 'aluminum_50x70', name: '鋁框吊框 50*70', category: '鋁框吊框', price: 3000, unit: '樘' },
        { id: 'tall_frame_40x240', name: '高門框 40*240', category: '高門框', price: 7500, unit: '樘' },
        { id: 'tall_frame_45x240', name: '高門框 45*240', category: '高門框', price: 8500, unit: '樘' },
        { id: 'tall_frame_50x240', name: '高門框 50*240', category: '高門框', price: 9500, unit: '樘' }
      ];
      othersForExcel.forEach(item => {
        const value = parseFloat(document.getElementById(item.id).value) || 0;
        if (value > 0) {
          const amt = value * item.price;
          items.push([item.category, item.name, value, `${value}${item.unit} × ${item.price}`, amt]);
          total += amt;
        }
      });

      // 自動項目：木作五金 5%
      const woodworkHardware = woodworkTotal * 0.05;
      if (woodworkHardware > 0) { items.push(['自動項目', '木作五金', 1, '木作小計 × 5%', woodworkHardware]); total += woodworkHardware; }

      // 自動項目：系統五金/運費/組裝（包含床架）
      const systemHardware = systemTotal * 0.05;
      const systemShipping = systemTotal * 0.05;
      const systemAssembly = systemTotal * 0.20;
      if (systemHardware > 0) { items.push(['自動項目', '系統五金', 1, '系統小計 × 5%', systemHardware]); total += systemHardware; }
      if (systemShipping > 0) { items.push(['自動項目', '運費', 1, '系統小計 × 5%', systemShipping]); total += systemShipping; }
      if (systemAssembly > 0) { items.push(['自動項目', '組裝費', 1, '系統小計 × 20%', systemAssembly]); total += systemAssembly; }

      // 自動項目：其他項目 10%
      const otherItemsAmount = total * 0.10;
      if (otherItemsAmount > 0) { items.push(['自動項目', '其他項目(10%)', 1, '目前小計 × 10%', otherItemsAmount]); total += otherItemsAmount; }

      // 自動項目：監工費 8%
      const supervisionFee = total * 0.08;
      if (supervisionFee > 0) { items.push(['自動項目', '監工費(8%)', 1, '目前小計 × 8%', supervisionFee]); total += supervisionFee; }

      // 自動項目：稅額 5%
      const tax = total * 0.05;
      if (tax > 0) { items.push(['自動項目', '稅額(5%)', 1, '目前小計 × 5%', tax]); total += tax; }

      const grandTotal = total;

      // ===== 組 Excel =====
      const grouped = {};
      items.forEach(([cat, name, qty, desc, price]) => {
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push([name, qty, desc, price]);
      });

      const wsData = [];
      wsData.push(["報價單"]);
      wsData.push([]);
      wsData.push(["=== 客戶資料 ==="]);
      clientData.forEach(row => wsData.push(row));
      wsData.push([]);

      Object.keys(grouped).forEach(cat => {
        wsData.push([cat]);
        let sub = 0;
        grouped[cat].forEach(([name, qty, desc, price]) => {
          sub += price;
          wsData.push(["", name, qty, desc, `NT$ ${price.toLocaleString()}`]);
        });
        wsData.push(["", "小計", "", "", `NT$ ${sub.toLocaleString()}`]);
        wsData.push([]);
      });

      wsData.push(["總金額", "", "", "", `NT$ ${grandTotal.toLocaleString()}`]);

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);

      //（注意：社群版 XLSX 對樣式支援有限，以下可能被忽略）
      try {
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
          const firstCell = ws[XLSX.utils.encode_cell({ r: R, c: 0 })];
          if (firstCell && typeof firstCell.v === 'string') {
            if (firstCell.v.includes("工程") || firstCell.v === "開關面板" || firstCell.v.includes("框") || firstCell.v.includes("項目") || firstCell.v === "床架" || firstCell.v === "自動項目") {
              firstCell.s = { fill: { fgColor: { rgb: "DDDDDD" } }, font: { bold: true } };
            }
            if (firstCell.v === "總金額") {
              firstCell.s = { fill: { fgColor: { rgb: "FFF2CC" } }, font: { bold: true } };
            }
          }
        }
      } catch(e) { /* 忽略樣式錯誤 */ }

      XLSX.utils.book_append_sheet(wb, ws, "報價單");
      XLSX.writeFile(wb, "室內裝修報價單.xlsx");
    }

    // 讓 HTML 中的 onclick/onchange 找得到這兩個函式
    window.calculatePricing = calculatePricing;
    window.exportToExcel = exportToExcel;
  </script>
  <script>
// 將 "NT$ 1,234" 之類字串 -> 數字
function _parseMoney(s){ return Number(String(s||'').replace(/[^\d.-]/g,'')) || 0; }

// 收集整張表單的原始輸入（方便備查/還原）
function _collectRawForm(){
  const obj = {};
  document.querySelectorAll('#quotationForm input, #quotationForm select').forEach(el=>{
    if(!el.id) return;
    if(el.type === 'checkbox') obj[el.id] = !!el.checked;
    else obj[el.id] = el.value;
  });
  return obj;
}

async function saveQuote(){
  const btn = document.querySelector('button[onclick="saveQuote()"]');
  try{
    if (btn) { btn.disabled = true; btn.textContent = '儲存中…'; }

    // 你的原本內容從這裡開始
    calculatePricing();
    const style = getStyleValue();
    const room  = getRoomTypeValue();
    const raw   = _collectRawForm();

    const other10   = _parseMoney(document.getElementById('other_items').value);
    const supervise8= _parseMoney(document.getElementById('supervision_fee').value);
    const tax5      = _parseMoney(document.getElementById('tax').value);
    const grand     = _parseMoney(document.getElementById('total-price').textContent);

    const quote = {
      quote_date: raw['date'] || null,
      client_name: raw['client_name'] || null,
      address: raw['address'] || null,
      style: style || null,
      room_type: room || null,
      base_ping: parseFloat(raw['base_ping']) || null,
      subtotal: Math.max(0, grand - other10 - supervise8 - tax5),
      other_items: other10,
      supervision_fee: supervise8,
      tax: tax5,
      grand_total: grand,
      form: raw
    };
    const payload = { quote, items: [] };

    const resp = await fetch('/api/save-quote', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    if(!resp.ok) throw new Error(data?.error || '儲存失敗');

    alert('已儲存成功！編號：' + data.id);
  }catch(err){
    console.error(err);
    alert('儲存失敗：' + (err.message || err));
  }finally{
    if (btn) { btn.disabled = false; btn.textContent = '儲存到資料庫'; }
  }
}
</script>
<script>
// 讓 HTML 裡的 onclick 找得到它們（避免「按了沒反應」）
window.calculatePricing = calculatePricing;
window.exportToExcel   = exportToExcel;
window.saveQuote       = saveQuote;
window.addBedFrame     = addBedFrame;
window.removeBedFrame  = removeBedFrame;
window.getStyleValue   = getStyleValue;
window.getRoomTypeValue= getRoomTypeValue;
</script>

</body>
</html>
